<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>1. Overview • bage</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="1. Overview">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bage</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/vig01_intro.html">1. Overview</a></li>
    <li><a class="dropdown-item" href="../articles/vig02_math.html">2. Mathematical Details</a></li>
    <li><a class="dropdown-item" href="../articles/vig03_priors.html">3. Priors</a></li>
    <li><a class="dropdown-item" href="../articles/vig04_svd.html">4. Singular Value Decomposition</a></li>
    <li><a class="dropdown-item" href="../articles/vig05_bdef.html">5. Examples from BDEF Book</a></li>
    <li><a class="dropdown-item" href="../articles/vig06_mortality.html">6. Modelling Mortality</a></li>
    <li><a class="dropdown-item" href="../articles/vig07_simulation.html">7. Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/vig08_workflow.html">8. Bayesian Workflow</a></li>
    <li><a class="dropdown-item" href="../articles/vig09_covariates.html">9. Covariates</a></li>
    <li><a class="dropdown-item" href="../articles/vig10_datamod.html">10. Data Models</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bayesiandemography/bage/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>1. Overview</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bayesiandemography/bage/blob/main/vignettes/vig01_intro.Rmd" class="external-link"><code>vignettes/vig01_intro.Rmd</code></a></small>
      <div class="d-none name"><code>vig01_intro.Rmd</code></div>
    </div>

    
    
<div class="section level2" number="1">
<h2 id="introduction">
<span class="header-section-number">1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><code>bage</code> (= “Bayesian” + “age”) implements Bayesian hierarchical models for rates, probabilities, and means. The rates, probabilities, and means are cross-classified by variables such as age, sex, region, and time. Models in <code>bage</code> can be used for estimation and for forecasting.</p>
<p><code>bage</code> models are built out of smaller submodels. A model for mortality rates, for instance, might contain submodels describing how rates vary over age, sex, and time.</p>
<p>Internally, <code>bage</code> draws on package <a href="https://CRAN.R-project.org/package=TMB" class="external-link">TMB</a> for fitting. <code>TMB</code> is fast and can handle large datasets.</p>
<p>This vignette introduces the main features of <code>bage</code>, using data on injuries as a case study.</p>
</div>
<div class="section level2" number="2">
<h2 id="preliminaries">
<span class="header-section-number">2</span> Preliminaries<a class="anchor" aria-label="anchor" href="#preliminaries"></a>
</h2>
<div class="section level3" number="2.1">
<h3 id="packages">
<span class="header-section-number">2.1</span> Packages<a class="anchor" aria-label="anchor" href="#packages"></a>
</h3>
<p>We begin by loading the packages that we will need for analysing the injuries data. Loading <code>bage</code> automatically loads package <code>rvec</code>, which contains functions for working with draws from probability distributions. Package <code>poputils</code> contains functions for working with demographic data. Packages <code>dplyr</code> and <code>tidyr</code> are core <a href="https://www.tidyverse.org" class="external-link">tidyverse</a> packages for manipulating data. We use <code>ggplot2</code> for graphics.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bayesiandemography.github.io/bage/">bage</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bayesiandemography.github.io/poputils/" class="external-link">poputils</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3" number="2.2">
<h3 id="data">
<span class="header-section-number">2.2</span> Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<p>We analyse a dataset called <code>nzl_injuries</code>. The dataset is included in <code>bage</code>. It contains counts of fatal injuries and population in New Zealand, classified by age, sex, ethnicity, and year.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">nzl_injuries</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 6</span></span></span>
<span><span class="co">#&gt;   age   sex    ethnicity  year injuries  popn</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 0-4   Female Maori      <span style="text-decoration: underline;">2</span>000       12 <span style="text-decoration: underline;">35</span>830</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 5-9   Female Maori      <span style="text-decoration: underline;">2</span>000        6 <span style="text-decoration: underline;">35</span>120</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 10-14 Female Maori      <span style="text-decoration: underline;">2</span>000        3 <span style="text-decoration: underline;">32</span>830</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 15-19 Female Maori      <span style="text-decoration: underline;">2</span>000        6 <span style="text-decoration: underline;">27</span>130</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 20-24 Female Maori      <span style="text-decoration: underline;">2</span>000        6 <span style="text-decoration: underline;">24</span>380</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 25-29 Female Maori      <span style="text-decoration: underline;">2</span>000        6 <span style="text-decoration: underline;">24</span>160</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nzl_injuries</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">2006</span>, <span class="fl">2012</span>, <span class="fl">2018</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://bayesiandemography.github.io/poputils/reference/age_lower.html" class="external-link">age_mid</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">injuries</span> <span class="op">/</span> <span class="va">popn</span>, color <span class="op">=</span> <span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">ethnicity</span><span class="op">)</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"age"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>        legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig01_intro_files/figure-html/unnamed-chunk-3-1.png"><!-- --></p>
</div>
</div>
<div class="section level2" number="3">
<h2 id="specifying-a-model">
<span class="header-section-number">3</span> Specifying a model<a class="anchor" aria-label="anchor" href="#specifying-a-model"></a>
</h2>
<div class="section level3" number="3.1">
<h3 id="functions-for-specifying-models">
<span class="header-section-number">3.1</span> Functions for specifying models<a class="anchor" aria-label="anchor" href="#functions-for-specifying-models"></a>
</h3>
<p>We specify a model where counts of injuries are treated as a random draws from Poisson distributions. The expected number of injuries varies with different combinations of age, sex, ethnicity, and year.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mod_pois.html">mod_pois</a></span><span class="op">(</span><span class="va">injuries</span> <span class="op">~</span> <span class="va">age</span> <span class="op">*</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">age</span> <span class="op">*</span> <span class="va">ethnicity</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>                data <span class="op">=</span> <span class="va">nzl_injuries</span>,</span>
<span>                exposure <span class="op">=</span> <span class="va">popn</span><span class="op">)</span></span></code></pre></div>
<p>Binomial models are specified with function <code><a href="../reference/mod_binom.html">mod_binom()</a></code> and normal models with function <code><a href="../reference/mod_norm.html">mod_norm()</a></code>.</p>
</div>
<div class="section level3" number="3.2">
<h3 id="model-structure">
<span class="header-section-number">3.2</span> Model structure<a class="anchor" aria-label="anchor" href="#model-structure"></a>
</h3>
<p>The resulting model has the following structure:</p>
<p><img src="vig01_dag.png" width="90%"></p>
<p>The number of injuries occurring within each combination of age, sex, ethnicity, and time reflects (i) the population at risk and (ii) an underlying rate that in <code>bage</code> is referred to as <code>.fitted</code>. The expected value for <code>.fitted</code> is obtained by summing up values for the intercept, age effect, sex effect, and so forth. The actual value of <code>.fitted</code> can diverge from <code>.expected</code>: the amount of divergence is governed by the <code>disp</code> (dispersion) parameter.</p>
<p>The model terms are all given “prior distributions”. A prior distribution is a submodel capturing features of the unknown quantity or quantities being estimated. Possible features include the range within which the quantity is likely to fall, or the amount of smoothness expected in series of values. Priors distributions are a distinctive feature of Bayesian methods.</p>
</div>
<div class="section level3" number="3.3">
<h3 id="printing-the-model-object">
<span class="header-section-number">3.3</span> Printing the model object<a class="anchor" aria-label="anchor" href="#printing-the-model-object"></a>
</h3>
<p>Printing a model object provides information on its structure:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     ------ Unfitted Poisson model ------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    injuries ~ age * sex + age * ethnicity + year</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  exposure: popn</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           term  prior along n_par n_par_free</span></span>
<span><span class="co">#&gt;    (Intercept) NFix()     -     1          1</span></span>
<span><span class="co">#&gt;            age   RW()   age    12         12</span></span>
<span><span class="co">#&gt;            sex NFix()     -     2          2</span></span>
<span><span class="co">#&gt;      ethnicity NFix()     -     2          2</span></span>
<span><span class="co">#&gt;           year   RW()  year    19         19</span></span>
<span><span class="co">#&gt;        age:sex   RW()   age    24         24</span></span>
<span><span class="co">#&gt;  age:ethnicity   RW()   age    24         24</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  disp: mean = 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  n_draw var_time var_age var_sexgender</span></span>
<span><span class="co">#&gt;    1000     year     age           sex</span></span></code></pre></div>
<p>The table in the the middle of the printout above shows the default prior distribution assigned to each term. We return to priors in Section <a href="#sec:priors">6</a>.</p>
<p>The bottom row of the printed object shows various model settings. <code>n_draw</code> is the number of random draws produced by extractor functions, which we discuss in Section <a href="#sec:outputs">5</a>. <code>var_time</code>, <code>var_age</code>, and <code>var_sexgender</code> are the names of the variables in <code>nzl_injuries</code> that represent time, age, and sex or gender. If <code>bage</code> fails to correctly identify these variables, they can be identified using functions such as <code><a href="../reference/set_var_time.html">set_var_time()</a></code>.</p>
</div>
</div>
<div class="section level2" number="4">
<h2 id="sec:fitting">
<span class="header-section-number">4</span> Fitting a model<a class="anchor" aria-label="anchor" href="#sec:fitting"></a>
</h2>
<div class="section level3" number="4.1">
<h3 id="fit">
<span class="header-section-number">4.1</span> fit()<a class="anchor" aria-label="anchor" href="#fit"></a>
</h3>
<p>Function <code><a href="../reference/mod_pois.html">mod_pois()</a></code> specifies a model, but does not actually estimate any of the unknown quantities in the model. For that, we need function <code><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit()</a></code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="va">mod</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3" number="4.2">
<h3 id="reprinting-the-model-object">
<span class="header-section-number">4.2</span> Reprinting the model object<a class="anchor" aria-label="anchor" href="#reprinting-the-model-object"></a>
</h3>
<p>The printout for a fitted model differs from that of an unfitted model.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     ------ Fitted Poisson model ------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    injuries ~ age * sex + age * ethnicity + year</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  exposure: popn</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           term  prior along n_par n_par_free std_dev</span></span>
<span><span class="co">#&gt;    (Intercept) NFix()     -     1          1       -</span></span>
<span><span class="co">#&gt;            age   RW()   age    12         12    0.71</span></span>
<span><span class="co">#&gt;            sex NFix()     -     2          2    0.11</span></span>
<span><span class="co">#&gt;      ethnicity NFix()     -     2          2    0.36</span></span>
<span><span class="co">#&gt;           year   RW()  year    19         19    0.09</span></span>
<span><span class="co">#&gt;        age:sex   RW()   age    24         24    0.43</span></span>
<span><span class="co">#&gt;  age:ethnicity   RW()   age    24         24    0.13</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  disp: mean = 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  n_draw var_time var_age var_sexgender optimizer</span></span>
<span><span class="co">#&gt;    1000     year     age           sex    nlminb</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  time_total time_max time_draw iter converged                    message</span></span>
<span><span class="co">#&gt;        0.77     0.31      0.35   11      TRUE   relative convergence (4)</span></span></code></pre></div>
<p>Among other things, a new row appears at the bottom of the printout, providing information about the fitting process. The most important value piece of information is whether the calculations have converged.</p>
<p>One thing the printout does not include is estimates for the model parameters. The reason for excluding them is that there are too many. Statistical models in other R packages often focus on one or two key parameters, such a parameter measuring a treatment effect. In contrast, models in <code>bage</code> often estimate values for thousands, or tens of thousands, of parameters.</p>
<p>To obtain the estimates from a fitted model, we need specialised extractor functions, which we discuss next.</p>
</div>
</div>
<div class="section level2" number="5">
<h2 id="sec:outputs">
<span class="header-section-number">5</span> Extracting outputs<a class="anchor" aria-label="anchor" href="#sec:outputs"></a>
</h2>
<div class="section level3" number="5.1">
<h3 id="extractor-functions">
<span class="header-section-number">5.1</span> Extractor functions<a class="anchor" aria-label="anchor" href="#extractor-functions"></a>
</h3>
<p>The two most important extractor functions in <code>bage</code> are <code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code> and <code><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components()</a></code>. Both of these are generic functions that work on many sorts of R objects (see <a href="https://generics.r-lib.org/index.html" class="external-link">here</a> and <a href="https://www.tidymodels.org/learn/develop/broom/#glossary" class="external-link">here</a>).</p>
</div>
<div class="section level3" number="5.2">
<h3 id="augment">
<span class="header-section-number">5.2</span> augment()<a class="anchor" aria-label="anchor" href="#augment"></a>
</h3>
<p><code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code> returns the original dataset plus some additional columns of estimated values,</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aug</span> <span class="op">&lt;-</span> <span class="va">mod</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">aug</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 912 × 9</span></span></span>
<span><span class="co">#&gt;    age   sex    ethnicity  year injuries  popn .observed</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 0-4   Female Maori      <span style="text-decoration: underline;">2</span>000       12 <span style="text-decoration: underline;">35</span>830 0.000<span style="text-decoration: underline;">335</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 5-9   Female Maori      <span style="text-decoration: underline;">2</span>000        6 <span style="text-decoration: underline;">35</span>120 0.000<span style="text-decoration: underline;">171</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 10-14 Female Maori      <span style="text-decoration: underline;">2</span>000        3 <span style="text-decoration: underline;">32</span>830 0.000<span style="text-decoration: underline;">091</span>4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 15-19 Female Maori      <span style="text-decoration: underline;">2</span>000        6 <span style="text-decoration: underline;">27</span>130 0.000<span style="text-decoration: underline;">221</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 20-24 Female Maori      <span style="text-decoration: underline;">2</span>000        6 <span style="text-decoration: underline;">24</span>380 0.000<span style="text-decoration: underline;">246</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 25-29 Female Maori      <span style="text-decoration: underline;">2</span>000        6 <span style="text-decoration: underline;">24</span>160 0.000<span style="text-decoration: underline;">248</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 30-34 Female Maori      <span style="text-decoration: underline;">2</span>000       12 <span style="text-decoration: underline;">22</span>560 0.000<span style="text-decoration: underline;">532</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 35-39 Female Maori      <span style="text-decoration: underline;">2</span>000        3 <span style="text-decoration: underline;">22</span>230 0.000<span style="text-decoration: underline;">135</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 40-44 Female Maori      <span style="text-decoration: underline;">2</span>000        6 <span style="text-decoration: underline;">18</span>130 0.000<span style="text-decoration: underline;">331</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 45-49 Female Maori      <span style="text-decoration: underline;">2</span>000        6 <span style="text-decoration: underline;">13</span>770 0.000<span style="text-decoration: underline;">436</span> </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 902 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: .fitted &lt;rdbl&lt;1000&gt;&gt;, .expected &lt;rdbl&lt;1000&gt;&gt;</span></span></span></code></pre></div>
<p>The additional columns are <code>.observed</code>, <code>.fitted</code>, and <code>.expected</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aug</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.observed</span>, <span class="va">.fitted</span>, <span class="va">.expected</span><span class="op">)</span> </span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 912 × 3</span></span></span>
<span><span class="co">#&gt;    .observed                    .fitted                  .expected</span></span>
<span><span class="co">#&gt;        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 0.000<span style="text-decoration: underline;">335</span>    3e-04 (0.00023, 0.00039) 0.00029 (0.00026, 0.00034)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 0.000<span style="text-decoration: underline;">171</span>  7.8e-05 (5.7e-05, 0.00011)   7.5e-05 (6.1e-05, 9e-05)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 0.000<span style="text-decoration: underline;">091</span>4   1e-04 (7.4e-05, 0.00014)   1e-04 (8.6e-05, 0.00012)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 0.000<span style="text-decoration: underline;">221</span>  0.00041 (0.00031, 0.00052)   0.00045 (4e-04, 0.00051)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 0.000<span style="text-decoration: underline;">246</span>  0.00038 (0.00029, 0.00049) 0.00041 (0.00036, 0.00046)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 0.000<span style="text-decoration: underline;">248</span>  0.00035 (0.00027, 0.00045) 0.00037 (0.00032, 0.00041)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 0.000<span style="text-decoration: underline;">532</span>    0.00038 (3e-04, 0.00049) 0.00036 (0.00032, 0.00042)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 0.000<span style="text-decoration: underline;">135</span>  0.00031 (0.00024, 0.00041)   0.00034 (3e-04, 0.00039)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 0.000<span style="text-decoration: underline;">331</span>  0.00033 (0.00025, 0.00043) 0.00033 (0.00029, 0.00038)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 0.000<span style="text-decoration: underline;">436</span>  0.00031 (0.00024, 0.00041) 0.00031 (0.00027, 0.00035)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 902 more rows</span></span></span></code></pre></div>
<p>In a Poisson model with exposures,</p>
<ul>
<li>
<code>.observed</code> is a “direct” estimate of the rate, obtained by dividing the the outcome variable by the population at risk;</li>
<li>
<code>.expected</code> is a model-based estimate of the rate, based purely on model predictors (eg age, sex, time); and</li>
<li>
<code>.fitted</code> is a model-based estimate of the rate that is a compromise between <code>.observed</code> and <code>.expected</code>.</li>
</ul>
</div>
<div class="section level3" number="5.3">
<h3 id="components">
<span class="header-section-number">5.3</span> components()<a class="anchor" aria-label="anchor" href="#components"></a>
</h3>
<p><code><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components()</a></code> is used to extract values for higher-level parameters. It returns values for all the parameters.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comp</span> <span class="op">&lt;-</span> <span class="va">mod</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">comp</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 89 × 4</span></span></span>
<span><span class="co">#&gt;    term        component level                  .fitted</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> (Intercept) effect    (Intercept) -1.7 (-3.4, 0.046)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> age         effect    0-4          -1.7 (-3.4, 0.03)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> age         effect    5-9          -2.9 (-4.6, -1.2)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> age         effect    10-14       -2.5 (-4.2, -0.73)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> age         effect    15-19        -0.89 (-2.6, 0.9)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> age         effect    20-24       -0.78 (-2.5, 0.96)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> age         effect    25-29       -0.91 (-2.6, 0.87)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> age         effect    30-34       -0.96 (-2.7, 0.91)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> age         effect    35-39       -0.97 (-2.8, 0.87)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> age         effect    40-44       -0.97 (-2.7, 0.86)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 79 more rows</span></span></span></code></pre></div>
<p>The output from <code><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components()</a></code> may require a bit of tidying,</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">age_effect</span> <span class="op">&lt;-</span> <span class="va">comp</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"age"</span>,</span>
<span>         <span class="va">component</span> <span class="op">==</span> <span class="st">"effect"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>age <span class="op">=</span> <span class="va">level</span>, <span class="va">.fitted</span><span class="op">)</span></span>
<span><span class="va">age_effect</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 12 × 2</span></span></span>
<span><span class="co">#&gt;    age              .fitted</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 0-4    -1.7 (-3.4, 0.03)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 5-9    -2.9 (-4.6, -1.2)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 10-14 -2.5 (-4.2, -0.73)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 15-19  -0.89 (-2.6, 0.9)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 20-24 -0.78 (-2.5, 0.96)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 25-29 -0.91 (-2.6, 0.87)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 30-34 -0.96 (-2.7, 0.91)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 35-39 -0.97 (-2.8, 0.87)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 40-44 -0.97 (-2.7, 0.86)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 45-49    -1 (-2.8, 0.89)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> 50-54    -1 (-2.8, 0.95)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> 55-59    -1 (-2.8, 0.94)</span></span></code></pre></div>
</div>
<div class="section level3" number="5.4">
<h3 id="posterior-samples">
<span class="header-section-number">5.4</span> Posterior samples<a class="anchor" aria-label="anchor" href="#posterior-samples"></a>
</h3>
<p>The output from a Bayesian model is draws from the “posterior distribution” for unknown quantities. The posterior distribution is a probability distribution that describes what is implied about the unknown quantities in the model after the combining model assumptions (including priors) and the data.</p>
</div>
<div class="section level3" number="5.5">
<h3 id="rvecs">
<span class="header-section-number">5.5</span> Rvecs<a class="anchor" aria-label="anchor" href="#rvecs"></a>
</h3>
<p>Draws from probability distributions can be awkward to work with, so <code>bage</code> uses a special type of vector called an “rvec”, implemented by package <code>rvec</code>. An rvec contains multiple draws, but tries to behave as much as possible like a standard vector. The printout of <code>.fitted</code> and <code>.expected</code> in the <code>aug</code> object above shows medians and 95% credible intervals.</p>
</div>
<div class="section level3" number="5.6">
<h3 id="graphing-outputs">
<span class="header-section-number">5.6</span> Graphing outputs<a class="anchor" aria-label="anchor" href="#graphing-outputs"></a>
</h3>
<p>The best way to understand output from a fitted model it to graph it. We first need to prepare data for the graph. We select values for 2018 and use the <code><a href="https://bayesiandemography.github.io/rvec/reference/draws_ci.html" class="external-link">draws_ci()</a></code> function from <code>rvec</code> to create 95% credible intervals.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_plot</span> <span class="op">&lt;-</span> <span class="va">aug</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2018</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://bayesiandemography.github.io/rvec/reference/draws_ci.html" class="external-link">draws_ci</a></span><span class="op">(</span><span class="va">.fitted</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data_plot</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">".fitted"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 48 × 4</span></span></span>
<span><span class="co">#&gt;                       .fitted .fitted.lower .fitted.mid .fitted.upper</span></span>
<span><span class="co">#&gt;                  <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 0.00023 (0.00017, 0.00029)     0.000<span style="text-decoration: underline;">171</span>    0.000<span style="text-decoration: underline;">225</span>      0.000<span style="text-decoration: underline;">292</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 5.7e-05 (4.1e-05, 7.8e-05)     0.000<span style="text-decoration: underline;">041</span>3   0.000<span style="text-decoration: underline;">057</span>5     0.000<span style="text-decoration: underline;">078</span>0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 8.6e-05 (6.5e-05, 0.00011)     0.000<span style="text-decoration: underline;">065</span>2   0.000<span style="text-decoration: underline;">086</span>0     0.000<span style="text-decoration: underline;">114</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 0.00036 (0.00028, 0.00045)     0.000<span style="text-decoration: underline;">282</span>    0.000<span style="text-decoration: underline;">360</span>      0.000<span style="text-decoration: underline;">452</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 0.00035 (0.00026, 0.00044)     0.000<span style="text-decoration: underline;">261</span>    0.000<span style="text-decoration: underline;">348</span>      0.000<span style="text-decoration: underline;">438</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 0.00032 (0.00024, 0.00041)     0.000<span style="text-decoration: underline;">245</span>    0.000<span style="text-decoration: underline;">319</span>      0.000<span style="text-decoration: underline;">409</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 0.00034 (0.00026, 0.00043)     0.000<span style="text-decoration: underline;">263</span>    0.000<span style="text-decoration: underline;">340</span>      0.000<span style="text-decoration: underline;">429</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 0.00027 (0.00021, 0.00035)     0.000<span style="text-decoration: underline;">212</span>    0.000<span style="text-decoration: underline;">272</span>      0.000<span style="text-decoration: underline;">347</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 0.00028 (0.00022, 0.00036)     0.000<span style="text-decoration: underline;">216</span>    0.000<span style="text-decoration: underline;">280</span>      0.000<span style="text-decoration: underline;">360</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 0.00024 (0.00018, 0.00031)     0.000<span style="text-decoration: underline;">179</span>    0.000<span style="text-decoration: underline;">235</span>      0.000<span style="text-decoration: underline;">311</span> </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 38 more rows</span></span></span></code></pre></div>
<p>We then use <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot()</a></code> to visualise the outputs. A good way to display <code>bage</code> output is to use <code><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon()</a></code> to plot credible intervals, <code><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line()</a></code> to plot model-based point estimates, and <code><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point()</a></code> to plot direct estimates.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data_plot</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://bayesiandemography.github.io/poputils/reference/age_lower.html" class="external-link">age_mid</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">ethnicity</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.fitted.lower</span>,</span>
<span>                  ymax <span class="op">=</span> <span class="va">.fitted.upper</span><span class="op">)</span>,</span>
<span>              fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.fitted.mid</span><span class="op">)</span>,</span>
<span>            color <span class="op">=</span> <span class="st">"darkblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.observed</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"age"</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig01_intro_files/figure-html/unnamed-chunk-14-1.png"><!-- --></p>
</div>
</div>
<div class="section level2" number="6">
<h2 id="sec:priors">
<span class="header-section-number">6</span> Priors<a class="anchor" aria-label="anchor" href="#sec:priors"></a>
</h2>
<div class="section level3" number="6.1">
<h3 id="priors-in-bayesian-models">
<span class="header-section-number">6.1</span> Priors in Bayesian models<a class="anchor" aria-label="anchor" href="#priors-in-bayesian-models"></a>
</h3>
<p>In a Bayesian model, every parameter needs to be assigned a prior distribution. When the data provides abundant information about the parameter, the particular choice of prior distribution usually has little effect on the ultimate estimates for the parameter. But when the data provides only limited information, different priors can lead to very different estimates. The choice of prior is particularly important when forecasting, since the data provides provides only indirect information about the future.</p>
</div>
<div class="section level3" number="6.2">
<h3 id="current-priors-in-bage">
<span class="header-section-number">6.2</span> Current priors in bage<a class="anchor" aria-label="anchor" href="#current-priors-in-bage"></a>
</h3>
<p><code><a href="../reference/priors.html">help(priors)</a></code> produces a list of priors that have been implemented in <code>bage</code>.</p>
<p>Some examples:</p>
<ul>
<li>
<code><a href="../reference/NFix.html">NFix()</a></code>. Each element of the term being modeled is drawn from a normal distribution with mean <code>0</code>, and standard deviation <code>sd</code>. By default, <code>sd</code> is 1.</li>
<li>
<code><a href="../reference/N.html">N()</a></code>. Like <code><a href="../reference/NFix.html">NFix()</a></code>, but <code>sd</code> is estimated from the data.</li>
<li>
<code><a href="../reference/RW.html">RW()</a></code>. The elements of the term being modeled follow a random walk. This is appropriate for terms involving time and age, where neighboring elements are strongly correlated.</li>
<li>
<code><a href="../reference/AR1.html">AR1()</a></code>. First-order autoregressive process. Suitable for time series that revert to a mean value.</li>
</ul>
</div>
<div class="section level3" number="6.3">
<h3 id="defaults">
<span class="header-section-number">6.3</span> Defaults<a class="anchor" aria-label="anchor" href="#defaults"></a>
</h3>
<p><code>bage</code> uses the following rules to assign default priors to a model term:</p>
<ul>
<li>if the term has less than 3 elements, use <code><a href="../reference/NFix.html">NFix()</a></code>;</li>
<li>otherwise, if the term involves time, use <code><a href="../reference/RW.html">RW()</a></code>, with time as the `along’ dimension;</li>
<li>otherwise, if the term involves age, use <code><a href="../reference/RW.html">RW()</a></code>, with age as the `along’ dimension;</li>
<li>otherwise, use <code><a href="../reference/N.html">N()</a></code>.</li>
</ul>
<p>Priors can be over-ridden using <code><a href="../reference/set_prior.html">set_prior()</a></code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="va">mod</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_prior.html">set_prior</a></span><span class="op">(</span><span class="va">year</span> <span class="op">~</span> <span class="fu"><a href="../reference/AR1.html">AR1</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Replacing a prior deletes any existing estimates and returns a model to an ‘unfitted’ state.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/is_fitted.html">is_fitted</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>So we re-fit the model.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="va">mod</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3" number="6.4">
<h3 id="svd-based-priors">
<span class="header-section-number">6.4</span> SVD-based priors<a class="anchor" aria-label="anchor" href="#svd-based-priors"></a>
</h3>
<p><code>bage</code> implements a special type of prior based on applying a singular value decomposition (SVD) to data from an international database. These SVD-based priors represent the age-sex patterns in demographic processes such as fertility, mortality, and labor force participation in a parsimonious way. The model below, for instance, uses SVD-based priors for age effects and age-time interactions in a model of regional fertility rates in Korea. Note that the number of free parameters (denoted <code>n_par_free</code>) for <code>age</code> and <code>age:time</code> in the printout below is much less than the total number of parameters (denoted <code>n_par</code>) for <code>age</code> and <code>age:time</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_births</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mod_pois.html">mod_pois</a></span><span class="op">(</span><span class="va">births</span> <span class="op">~</span> <span class="va">age</span> <span class="op">*</span> <span class="va">region</span> <span class="op">+</span> <span class="va">age</span> <span class="op">*</span> <span class="va">time</span>,</span>
<span>                       data <span class="op">=</span> <span class="va">kor_births</span>,</span>
<span>                       exposure <span class="op">=</span> <span class="va">popn</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_prior.html">set_prior</a></span><span class="op">(</span><span class="va">age</span> <span class="op">~</span> <span class="fu"><a href="../reference/SVD.html">SVD</a></span><span class="op">(</span><span class="va">HFD</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_prior.html">set_prior</a></span><span class="op">(</span><span class="va">age</span><span class="op">:</span><span class="va">time</span> <span class="op">~</span> <span class="fu"><a href="../reference/SVD_AR.html">SVD_RW</a></span><span class="op">(</span><span class="va">HFD</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">mod_births</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     ------ Fitted Poisson model ------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    births ~ age * region + age * time</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  exposure: popn</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         term       prior along n_par n_par_free std_dev</span></span>
<span><span class="co">#&gt;  (Intercept)      NFix()     -     1          1       -</span></span>
<span><span class="co">#&gt;          age    SVD(HFD)     -     9          3    1.66</span></span>
<span><span class="co">#&gt;       region         N()     -    16         16    0.03</span></span>
<span><span class="co">#&gt;         time        RW()  time    13         13    0.46</span></span>
<span><span class="co">#&gt;   age:region        RW()   age   144        144    0.57</span></span>
<span><span class="co">#&gt;     age:time SVD_RW(HFD)  time   117         39    1.89</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  disp: mean = 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  n_draw var_time var_age optimizer</span></span>
<span><span class="co">#&gt;    1000     time     age    nlminb</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  time_total time_max time_draw iter converged                    message</span></span>
<span><span class="co">#&gt;        2.52     1.45      0.91   22      TRUE   relative convergence (4)</span></span></code></pre></div>
</div>
</div>
<div class="section level2" number="7">
<h2 id="covariates">
<span class="header-section-number">7</span> Covariates<a class="anchor" aria-label="anchor" href="#covariates"></a>
</h2>
<p>The main predictors in a <code>bage</code> model are the variables, such as age and sex, that are used to classify the outcome. However, <code>bage</code> does allow additional variables in <code>data</code> to be used as predictors. We refer to these additional variables as covariates, and we add them to a model using function <code><a href="../reference/set_covariates.html">set_covariates()</a></code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mod_pois.html">mod_pois</a></span><span class="op">(</span><span class="va">births</span> <span class="op">~</span> <span class="va">age</span> <span class="op">*</span> <span class="va">region</span> <span class="op">+</span> <span class="va">age</span> <span class="op">*</span> <span class="va">time</span>,</span>
<span>         data <span class="op">=</span> <span class="va">kor_births</span>,</span>
<span>         exposure <span class="op">=</span> <span class="va">popn</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_covariates.html">set_covariates</a></span><span class="op">(</span><span class="op">~</span> <span class="va">gdp_pc_2023</span> <span class="op">+</span> <span class="va">dens_2020</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     ------ Unfitted Poisson model ------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    births ~ age * region + age * time</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  exposure: popn</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         term  prior along n_par n_par_free</span></span>
<span><span class="co">#&gt;  (Intercept) NFix()     -     1          1</span></span>
<span><span class="co">#&gt;          age   RW()   age     9          9</span></span>
<span><span class="co">#&gt;       region    N()     -    16         16</span></span>
<span><span class="co">#&gt;         time   RW()  time    13         13</span></span>
<span><span class="co">#&gt;   age:region   RW()   age   144        144</span></span>
<span><span class="co">#&gt;     age:time   RW()  time   117        117</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  covariates: ~gdp_pc_2023 + dens_2020</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  disp: mean = 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  n_draw var_time var_age</span></span>
<span><span class="co">#&gt;    1000     time     age</span></span></code></pre></div>
</div>
<div class="section level2" number="8">
<h2 id="forecasting">
<span class="header-section-number">8</span> Forecasting<a class="anchor" aria-label="anchor" href="#forecasting"></a>
</h2>
<p>Forecasts can be constructed by calling function <code><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast()</a></code> on a model object. When the <code>output</code> argument of <code><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast()</a></code> is <code>"augment"</code> (the default), <code><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast()</a></code> produces values like those produced by <code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aug_forecast</span> <span class="op">&lt;-</span> <span class="va">mod</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fl">2019</span><span class="op">:</span><span class="fl">2028</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">aug_forecast</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "age"       "sex"       "ethnicity" "year"      "injuries"  "popn"     </span></span>
<span><span class="co">#&gt; [7] ".observed" ".fitted"   ".expected"</span></span></code></pre></div>
<p>When the <code>output</code> argument is <code>"components"</code>, <code><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast()</a></code> produces values like those produced by <code><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components()</a></code>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comp_forecast</span> <span class="op">&lt;-</span> <span class="va">mod</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fl">2019</span><span class="op">:</span><span class="fl">2028</span>,</span>
<span>           output <span class="op">=</span> <span class="st">"components"</span><span class="op">)</span></span>
<span><span class="va">comp_forecast</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 4</span></span></span>
<span><span class="co">#&gt;    term  component level              .fitted</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> year  effect    2019  -0.091 (-0.37, 0.17)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> year  effect    2020  -0.081 (-0.43, 0.26)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> year  effect    2021   -0.071 (-0.47, 0.3)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> year  effect    2022  -0.064 (-0.47, 0.35)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> year  effect    2023  -0.064 (-0.54, 0.38)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> year  effect    2024  -0.057 (-0.54, 0.42)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> year  effect    2025   -0.05 (-0.55, 0.42)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> year  effect    2026  -0.048 (-0.55, 0.41)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> year  effect    2027  -0.044 (-0.57, 0.48)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> year  effect    2028  -0.037 (-0.54, 0.53)</span></span></code></pre></div>
<p>When the argument <code>include_estimates</code> is <code>TRUE</code>, the return value includes historical estimates. This is useful for plotting.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_forecast</span> <span class="op">&lt;-</span> <span class="va">mod</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fl">2019</span><span class="op">:</span><span class="fl">2028</span>,</span>
<span>           include_estimates <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sex</span> <span class="op">==</span> <span class="st">"Female"</span>,</span>
<span>         <span class="va">age</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"10-14"</span>, <span class="st">"25-29"</span>, <span class="st">"40-44"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://bayesiandemography.github.io/rvec/reference/draws_ci.html" class="external-link">draws_ci</a></span><span class="op">(</span><span class="va">.fitted</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data_forecast</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">ethnicity</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.fitted.lower</span>,</span>
<span>                  ymax <span class="op">=</span> <span class="va">.fitted.upper</span><span class="op">)</span>,</span>
<span>              fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.fitted.mid</span><span class="op">)</span>,</span>
<span>            color <span class="op">=</span> <span class="st">"darkblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.observed</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span>  </span>
<span><span class="co">#&gt; Warning: Removed 60 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_point()`).</span></span></code></pre></div>
<p><img src="vig01_intro_files/figure-html/unnamed-chunk-22-1.png"><!-- --></p>
</div>
<div class="section level2" number="9">
<h2 id="imputation">
<span class="header-section-number">9</span> Imputation<a class="anchor" aria-label="anchor" href="#imputation"></a>
</h2>
<p><code>bage</code> automatically accommodates missing values in the outcome variables. We illustrate with a version of the injuries dataset where values for 2010–2014 are set to <code>NA</code>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">years_mis</span> <span class="op">&lt;-</span> <span class="fl">2010</span><span class="op">:</span><span class="fl">2014</span></span>
<span></span>
<span><span class="va">injuries_mis</span> <span class="op">&lt;-</span> <span class="va">nzl_injuries</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>injuries <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">years_mis</span>, <span class="cn">NA</span>, <span class="va">injuries</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We fit our exactly the same model that we use for the complete dataset.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_mis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mod_pois.html">mod_pois</a></span><span class="op">(</span><span class="va">injuries</span> <span class="op">~</span> <span class="va">age</span> <span class="op">*</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">age</span> <span class="op">*</span> <span class="va">ethnicity</span> <span class="op">+</span> <span class="va">year</span>,</span>
<span>                    data <span class="op">=</span> <span class="va">injuries_mis</span>,</span>
<span>                    exposure <span class="op">=</span> <span class="va">popn</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><code>bage</code> creates a new variable, called <code>.injuries</code> containing imputed values for the missing outcomes.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_mis</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">years_mis</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 240 × 10</span></span></span>
<span><span class="co">#&gt;    age   sex    ethnicity  year injuries    .injuries  popn .observed</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 0-4   Female Maori      <span style="text-decoration: underline;">2</span>010       <span style="color: #BB0000;">NA</span>   11 (5, 20) <span style="text-decoration: underline;">43</span>440        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 5-9   Female Maori      <span style="text-decoration: underline;">2</span>010       <span style="color: #BB0000;">NA</span>     3 (0, 7) <span style="text-decoration: underline;">36</span>340        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 10-14 Female Maori      <span style="text-decoration: underline;">2</span>010       <span style="color: #BB0000;">NA</span>     3 (0, 7) <span style="text-decoration: underline;">35</span>520        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 15-19 Female Maori      <span style="text-decoration: underline;">2</span>010       <span style="color: #BB0000;">NA</span>   14 (7, 23) <span style="text-decoration: underline;">34</span>960        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 20-24 Female Maori      <span style="text-decoration: underline;">2</span>010       <span style="color: #BB0000;">NA</span>   12 (5, 20) <span style="text-decoration: underline;">31</span>060        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 25-29 Female Maori      <span style="text-decoration: underline;">2</span>010       <span style="color: #BB0000;">NA</span>    8 (3, 16) <span style="text-decoration: underline;">24</span>000        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 30-34 Female Maori      <span style="text-decoration: underline;">2</span>010       <span style="color: #BB0000;">NA</span>    8 (3, 14) <span style="text-decoration: underline;">23</span>180        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 35-39 Female Maori      <span style="text-decoration: underline;">2</span>010       <span style="color: #BB0000;">NA</span>    8 (3, 13) <span style="text-decoration: underline;">24</span>260        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 40-44 Female Maori      <span style="text-decoration: underline;">2</span>010       <span style="color: #BB0000;">NA</span>    7 (2, 13) <span style="text-decoration: underline;">22</span>660        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 45-49 Female Maori      <span style="text-decoration: underline;">2</span>010       <span style="color: #BB0000;">NA</span>    6 (2, 12) <span style="text-decoration: underline;">21</span>730        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 230 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: .fitted &lt;rdbl&lt;1000&gt;&gt;, .expected &lt;rdbl&lt;1000&gt;&gt;</span></span></span></code></pre></div>
<p>Rates estimates in years where the outcome is missing have wider credible intervals than rates estimates in years where the outcome is observed.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_plot_mis</span> <span class="op">&lt;-</span> <span class="va">mod_mis</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">age</span> <span class="op">==</span> <span class="st">"20-24"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://bayesiandemography.github.io/rvec/reference/draws_ci.html" class="external-link">draws_ci</a></span><span class="op">(</span><span class="va">.fitted</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data_plot_mis</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">ethnicity</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.fitted.lower</span>,</span>
<span>                  ymax <span class="op">=</span> <span class="va">.fitted.upper</span><span class="op">)</span>,</span>
<span>              fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.fitted.mid</span><span class="op">)</span>,</span>
<span>            color <span class="op">=</span> <span class="st">"darkblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.observed</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"age"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 20 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_point()`).</span></span></code></pre></div>
<p><img src="vig01_intro_files/figure-html/unnamed-chunk-26-1.png"><!-- --></p>
<p>If the value for exposure, size, or weights is missing, then the associated row from <code>data</code> is omitted from the likelihood, and no imputations for that row are made. Missing values for classifying variables are skipped over in the same way.</p>
</div>
<div class="section level2" number="10">
<h2 id="data-models">
<span class="header-section-number">10</span> Data models<a class="anchor" aria-label="anchor" href="#data-models"></a>
</h2>
<p>Many datasets in applied demography have some sort of measurement error: units within the target population are missed, for instance, or are double-counted. In <code>bage</code>, measurement error can be explicitly incorporated into the analysis by adding a “data model” (also known as a measurement error model) to the base model.</p>
<p>Consider, for example, as dataset where, because of errors in the data collection process, responses for females are expected to be inflated by 5% and responses for males are expected to be inflated by 6%. We might extend our base model as follows:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prob_under</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>sex <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Female"</span>, <span class="st">"Male"</span><span class="op">)</span>,</span>
<span>                         mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>,     <span class="fl">0.06</span><span class="op">)</span>,</span>
<span>             disp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.02</span>,     <span class="fl">0.02</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod_under</span> <span class="op">&lt;-</span> <span class="va">mod_base</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_datamod_undercount.html">set_datamod_undercount</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="va">prob_under</span><span class="op">)</span> </span></code></pre></div>
<p>The current choice of data models in <code>bage</code> can be views by calling <code>help(datamod)</code>.</p>
</div>
<div class="section level2" number="11">
<h2 id="confidentialization">
<span class="header-section-number">11</span> Confidentialization<a class="anchor" aria-label="anchor" href="#confidentialization"></a>
</h2>
<p>Data producers often confidentialize their data before they make it publicly available. The <code>nzl_injuries</code> dataset is one example. Statistics New Zealand has randomly-rounded the counts of injuries to multiples of 3.</p>
<p>To deal with confidentialization, we describe the confidentialization process to our model.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="va">mod</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_confidential_rr3.html">set_confidential_rr3</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The results from calling <code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code> now include a variable called <code>.injuries</code> with estimated values for the true, unrounded injury counts.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 912 × 10</span></span></span>
<span><span class="co">#&gt;    age   sex    ethnicity  year injuries    .injuries  popn .observed</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 0-4   Female Maori      <span style="text-decoration: underline;">2</span>000       12  12 (10, 14) <span style="text-decoration: underline;">35</span>830 0.000<span style="text-decoration: underline;">335</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 5-9   Female Maori      <span style="text-decoration: underline;">2</span>000        6     5 (4, 7) <span style="text-decoration: underline;">35</span>120 0.000<span style="text-decoration: underline;">171</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 10-14 Female Maori      <span style="text-decoration: underline;">2</span>000        3     3 (1, 5) <span style="text-decoration: underline;">32</span>830 0.000<span style="text-decoration: underline;">091</span>4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 15-19 Female Maori      <span style="text-decoration: underline;">2</span>000        6     7 (5, 8) <span style="text-decoration: underline;">27</span>130 0.000<span style="text-decoration: underline;">221</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 20-24 Female Maori      <span style="text-decoration: underline;">2</span>000        6     6 (4, 8) <span style="text-decoration: underline;">24</span>380 0.000<span style="text-decoration: underline;">246</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 25-29 Female Maori      <span style="text-decoration: underline;">2</span>000        6     6 (4, 8) <span style="text-decoration: underline;">24</span>160 0.000<span style="text-decoration: underline;">248</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 30-34 Female Maori      <span style="text-decoration: underline;">2</span>000       12  12 (10, 14) <span style="text-decoration: underline;">22</span>560 0.000<span style="text-decoration: underline;">532</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 35-39 Female Maori      <span style="text-decoration: underline;">2</span>000        3     4 (2, 5) <span style="text-decoration: underline;">22</span>230 0.000<span style="text-decoration: underline;">135</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 40-44 Female Maori      <span style="text-decoration: underline;">2</span>000        6     6 (4, 8) <span style="text-decoration: underline;">18</span>130 0.000<span style="text-decoration: underline;">331</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 45-49 Female Maori      <span style="text-decoration: underline;">2</span>000        6     6 (4, 8) <span style="text-decoration: underline;">13</span>770 0.000<span style="text-decoration: underline;">436</span> </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 902 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: .fitted &lt;rdbl&lt;1000&gt;&gt;, .expected &lt;rdbl&lt;1000&gt;&gt;</span></span></span></code></pre></div>
</div>
<div class="section level2" number="12">
<h2 id="model-checking">
<span class="header-section-number">12</span> Model checking<a class="anchor" aria-label="anchor" href="#model-checking"></a>
</h2>
<div class="section level3" number="12.1">
<h3 id="replicate-data">
<span class="header-section-number">12.1</span> Replicate data<a class="anchor" aria-label="anchor" href="#replicate-data"></a>
</h3>
<p>A standard Bayesian approach to checking a model is to use the model to generate simulate data and see if the simulated data looks like the actual data. Function <code><a href="../reference/replicate_data.html">replicate_data()</a></code> creates multiple sets of simulated data.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep_data</span> <span class="op">&lt;-</span> <span class="va">mod</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/replicate_data.html">replicate_data</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rep_data</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 18,240 × 7</span></span></span>
<span><span class="co">#&gt;    .replicate age   sex    ethnicity  year injuries  popn</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Original   0-4   Female Maori      <span style="text-decoration: underline;">2</span>000       12 <span style="text-decoration: underline;">35</span>830</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Original   5-9   Female Maori      <span style="text-decoration: underline;">2</span>000        6 <span style="text-decoration: underline;">35</span>120</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Original   10-14 Female Maori      <span style="text-decoration: underline;">2</span>000        3 <span style="text-decoration: underline;">32</span>830</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Original   15-19 Female Maori      <span style="text-decoration: underline;">2</span>000        6 <span style="text-decoration: underline;">27</span>130</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Original   20-24 Female Maori      <span style="text-decoration: underline;">2</span>000        6 <span style="text-decoration: underline;">24</span>380</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Original   25-29 Female Maori      <span style="text-decoration: underline;">2</span>000        6 <span style="text-decoration: underline;">24</span>160</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Original   30-34 Female Maori      <span style="text-decoration: underline;">2</span>000       12 <span style="text-decoration: underline;">22</span>560</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Original   35-39 Female Maori      <span style="text-decoration: underline;">2</span>000        3 <span style="text-decoration: underline;">22</span>230</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Original   40-44 Female Maori      <span style="text-decoration: underline;">2</span>000        6 <span style="text-decoration: underline;">18</span>130</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Original   45-49 Female Maori      <span style="text-decoration: underline;">2</span>000        6 <span style="text-decoration: underline;">13</span>770</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 18,230 more rows</span></span></span></code></pre></div>
<p>Comparing full datasets is difficult, so the usual strategy is to calculate summary measures that capture some important feature of the data, and compare those instead. Here we see if the model is properly capturing male-female differences in injury rates.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sex_ratio</span> <span class="op">&lt;-</span> <span class="va">rep_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">.replicate</span>, <span class="va">year</span>, <span class="va">sex</span>, wt <span class="op">=</span> <span class="va">injuries</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">sex</span>, values_from <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ratio <span class="op">=</span> <span class="va">Male</span> <span class="op">/</span> <span class="va">Female</span><span class="op">)</span></span>
<span><span class="va">sex_ratio</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 380 × 5</span></span></span>
<span><span class="co">#&gt;    .replicate  year Female  Male ratio</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Original    <span style="text-decoration: underline;">2</span>000    279   873  3.13</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Original    <span style="text-decoration: underline;">2</span>001    276   846  3.07</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Original    <span style="text-decoration: underline;">2</span>002    303   855  2.82</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Original    <span style="text-decoration: underline;">2</span>003    330   873  2.65</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Original    <span style="text-decoration: underline;">2</span>004    306   840  2.75</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Original    <span style="text-decoration: underline;">2</span>005    300   876  2.92</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Original    <span style="text-decoration: underline;">2</span>006    291   828  2.85</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Original    <span style="text-decoration: underline;">2</span>007    321   843  2.63</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Original    <span style="text-decoration: underline;">2</span>008    339   864  2.55</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Original    <span style="text-decoration: underline;">2</span>009    303   900  2.97</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 370 more rows</span></span></span></code></pre></div>
<p>We graph the results and see if the original data looks like it was drawn from the same underlying distribution as the simulated data.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sex_ratio</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">ratio</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">.replicate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig01_intro_files/figure-html/unnamed-chunk-32-1.png"><!-- --></p>
</div>
<div class="section level3" number="12.2">
<h3 id="simulation-studies">
<span class="header-section-number">12.2</span> Simulation studies<a class="anchor" aria-label="anchor" href="#simulation-studies"></a>
</h3>
<p>A simulation study, where we create the data ourselves and hence know the true values for the parameters, can be a useful way of assessing model performance. In the example below, we use function <code><a href="../reference/report_sim.html">report_sim()</a></code> to perform a simple simulation study where the true population is generated using a first-order random walk, but the estimation model assumes that the population is generated using a second-order random walk.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Create simulated data</span></span>
<span><span class="va">fake_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2001</span><span class="op">:</span><span class="fl">2010</span>, </span>
<span>                        population <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Define the true data-generating model</span></span>
<span><span class="va">mod_rw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mod_pois.html">mod_pois</a></span><span class="op">(</span><span class="va">population</span> <span class="op">~</span> <span class="va">year</span>,</span>
<span>                   data <span class="op">=</span> <span class="va">fake_data</span>,</span>
<span>                   exposure <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_prior.html">set_prior</a></span><span class="op">(</span><span class="va">`(Intercept)`</span> <span class="op">~</span> <span class="fu"><a href="../reference/NFix.html">NFix</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_prior.html">set_prior</a></span><span class="op">(</span><span class="va">year</span> <span class="op">~</span> <span class="fu"><a href="../reference/RW.html">RW</a></span><span class="op">(</span>s <span class="op">=</span> <span class="fl">0.1</span>, sd <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Define the estimation model</span></span>
<span><span class="va">mod_rw2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mod_pois.html">mod_pois</a></span><span class="op">(</span><span class="va">population</span> <span class="op">~</span> <span class="va">year</span>,</span>
<span>                    data <span class="op">=</span> <span class="va">fake_data</span>,</span>
<span>                    exposure <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_prior.html">set_prior</a></span><span class="op">(</span><span class="va">year</span> <span class="op">~</span> <span class="fu"><a href="../reference/RW2.html">RW2</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Run the simulation</span></span>
<span><span class="fu"><a href="../reference/report_sim.html">report_sim</a></span><span class="op">(</span>mod_est <span class="op">=</span> <span class="va">mod_rw2</span>, mod_sim <span class="op">=</span> <span class="va">mod_rw</span><span class="op">)</span></span>
<span><span class="co">#&gt; $components</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 7</span></span></span>
<span><span class="co">#&gt;   term        component  .error .cover_50 .cover_95 .length_50 .length_95</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> (Intercept) effect    -<span style="color: #BB0000;">0.067</span><span style="color: #BB0000; text-decoration: underline;">4</span>     0.97       1          1.11       3.21</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> year        effect    -<span style="color: #BB0000;">0.287</span>      0.759      1          1.62       4.67</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> disp        disp      -<span style="color: #BB0000;">0.120</span>      0.44       0.87       1.11       4.72</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $augment</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 6</span></span></span>
<span><span class="co">#&gt;   .var       .error .cover_50 .cover_95 .length_50 .length_95</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> .fitted   -<span style="color: #BB0000;">0.151</span>      0.476     0.963      0.845       2.87</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> .expected -<span style="color: #BB0000;">0.051</span><span style="color: #BB0000; text-decoration: underline;">5</span>     0.516     0.992      0.991    <span style="text-decoration: underline;">4</span>461.</span></span></code></pre></div>
</div>
<div class="section level3" number="12.3">
<h3 id="prior-predictive-checks">
<span class="header-section-number">12.3</span> Prior predictive checks<a class="anchor" aria-label="anchor" href="#prior-predictive-checks"></a>
</h3>
<p>Another way of gaining insights about a model is to look at estimates based purely on the priors, without using data on the outcome variable. In <code>bage</code>, this can be done by calling <code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code>, <code><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components()</a></code> or <code><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast()</a></code> on an unfitted version of the model.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/unfit.html">unfit</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 90 × 4</span></span></span>
<span><span class="co">#&gt;    term        component level                  .fitted</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> (Intercept) effect    (Intercept)  -0.07 (-1.9, 1.9)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> age         effect    0-4            0.059 (-1.8, 2)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> age         effect    5-9          0.052 (-2.4, 2.8)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> age         effect    10-14        0.035 (-3.1, 3.6)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> age         effect    15-19        0.055 (-3.8, 3.9)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> age         effect    20-24        0.033 (-4.5, 4.4)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> age         effect    25-29        -0.0078 (-5, 5.2)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> age         effect    30-34       -0.018 (-5.5, 5.7)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> age         effect    35-39       -0.042 (-5.8, 6.2)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> age         effect    40-44        0.068 (-5.9, 6.5)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 80 more rows</span></span></span></code></pre></div>
</div>
</div>
<div class="section level2" number="13">
<h2 id="future-development-of-bage">
<span class="header-section-number">13</span> Future development of bage<a class="anchor" aria-label="anchor" href="#future-development-of-bage"></a>
</h2>
<div class="section level3" number="13.1">
<h3 id="future-features">
<span class="header-section-number">13.1</span> Future features<a class="anchor" aria-label="anchor" href="#future-features"></a>
</h3>
<p><code>bage</code> is a new package, and still under very active development. Some features that are next on the list are:</p>
<ul>
<li>
<strong>Priors</strong> More options for priors, eg a damped linear trend.</li>
<li>
<strong>Sets of priors</strong> Pre-specified collections of priors for specific purposes such as modelling fertility rates</li>
<li>
<strong>Documentation</strong> More vignettes and examples.</li>
<li>
<strong>Model choice</strong> Tools for model comparison and model choice</li>
</ul>
</div>
<div class="section level3" number="13.2">
<h3 id="experimental-status">
<span class="header-section-number">13.2</span> Experimental status<a class="anchor" aria-label="anchor" href="#experimental-status"></a>
</h3>
<p><code>bage</code> currently has an <a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="https://img.shields.io/badge/lifecycle-experimental-orange.svg" alt="Lifecycle: experimental"></a> life cycle badge, to warn users that some features of the <code>bage</code> interface, such as function arguments, are still evolving. We hope to graduate from experimental status by the end of 2025.</p>
</div>
<div class="section level3" number="13.3">
<h3 id="bug-reports-and-feature-requests">
<span class="header-section-number">13.3</span> Bug reports and feature requests<a class="anchor" aria-label="anchor" href="#bug-reports-and-feature-requests"></a>
</h3>
<p>We would be grateful for bug reports or suggestions for features. The best way to do so is to raise an issue on the <a href="https://github.com/bayesiandemography/bage/issues" class="external-link">bage GitHub repository</a>.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by John Bryant, Junni Zhang.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
