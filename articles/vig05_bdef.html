<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>5. Examples from BDEF Book • bage</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="5. Examples from BDEF Book">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bage</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.10.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/vig01_intro.html">1. Overview</a></li>
    <li><a class="dropdown-item" href="../articles/vig02_math.html">2. Mathematical Details</a></li>
    <li><a class="dropdown-item" href="../articles/vig03_priors.html">3. Priors</a></li>
    <li><a class="dropdown-item" href="../articles/vig04_svd.html">4. Singular Value Decomposition</a></li>
    <li><a class="dropdown-item" href="../articles/vig05_bdef.html">5. Examples from BDEF Book</a></li>
    <li><a class="dropdown-item" href="../articles/vig06_mortality.html">6. Modelling Mortality</a></li>
    <li><a class="dropdown-item" href="../articles/vig07_simulation.html">7. Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/vig08_workflow.html">8. Bayesian Workflow</a></li>
    <li><a class="dropdown-item" href="../articles/vig09_covariates.html">9. Covariates</a></li>
    <li><a class="dropdown-item" href="../articles/vig10_datamod.html">10. Data Models</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bayesiandemography/bage/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>5. Examples from BDEF Book</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bayesiandemography/bage/blob/main/vignettes/articles/vig05_bdef.Rmd" class="external-link"><code>vignettes/articles/vig05_bdef.Rmd</code></a></small>
      <div class="d-none name"><code>vig05_bdef.Rmd</code></div>
    </div>

    
    
<div class="section level2" number="1">
<h2 id="introduction">
<span class="header-section-number">1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette uses <code>bage</code> to replicate, with a few differences, case studies in the book <a href="https://www.bdef-book.com" class="external-link">Bayesian Demographic Estimation and Forecasting</a> (BDEF). BDEF uses our R package <a href="https://github.com/statisticsnz/demest" class="external-link">demest</a>. However, we strongly recommend using <code>bage</code> instead. <code>bage</code> is faster, more stable, and has a nicer interface. We are no longer developing <code>demest</code>, and are focusing on <code>bage</code>.</p>
<p>In addition to <code>bage</code>, the vignette uses the tidyverse packages <code>dplyr</code>, <code>tidyr</code>, and <code>ggplot2</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bayesiandemography.github.io/bage/">bage</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>The vignette includes notes aimed at readers of BDEF, pointing out differences between the models in <code>bage</code> and the models in BDEF, and explaning why we made the changes.</p>
<blockquote>
<p><strong>BDEF Note</strong></p>
<p>BDEF notes look like this.</p>
</blockquote>
</div>
<div class="section level2" number="2">
<h2 id="infant-mortality-in-sweden">
<span class="header-section-number">2</span> Infant Mortality in Sweden<a class="anchor" aria-label="anchor" href="#infant-mortality-in-sweden"></a>
</h2>
<div class="section level3" number="2.1">
<h3 id="aims-and-data">
<span class="header-section-number">2.1</span> Aims and data<a class="anchor" aria-label="anchor" href="#aims-and-data"></a>
</h3>
<p>We estimate and forecast infant mortality in Swedish counties. Following standard demographic practice we define the infant mortality rate as the probability of dying during the first year of life, calculated using this year’s infant deaths and this year’s births. (See Chapter 11 of BDEF on why this definition is slightly odd.)</p>
<p>Data for the analysis is in the <code>swe_infant</code> dataset in <code>bage</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">swe_infant</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 441 × 4</span></span></span>
<span><span class="co">#&gt;    county     time births deaths</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Stockholm  <span style="text-decoration: underline;">1</span>995  <span style="text-decoration: underline;">22</span>626     96</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Stockholm  <span style="text-decoration: underline;">1</span>996  <span style="text-decoration: underline;">21</span>354     74</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Stockholm  <span style="text-decoration: underline;">1</span>997  <span style="text-decoration: underline;">20</span>646     62</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Stockholm  <span style="text-decoration: underline;">1</span>998  <span style="text-decoration: underline;">20</span>815     81</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Stockholm  <span style="text-decoration: underline;">1</span>999  <span style="text-decoration: underline;">20</span>863     68</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Stockholm  <span style="text-decoration: underline;">2</span>000  <span style="text-decoration: underline;">21</span>837     75</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Stockholm  <span style="text-decoration: underline;">2</span>001  <span style="text-decoration: underline;">22</span>622     68</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Stockholm  <span style="text-decoration: underline;">2</span>002  <span style="text-decoration: underline;">24</span>084     70</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Stockholm  <span style="text-decoration: underline;">2</span>003  <span style="text-decoration: underline;">25</span>028     67</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Stockholm  <span style="text-decoration: underline;">2</span>004  <span style="text-decoration: underline;">25</span>779     64</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 431 more rows</span></span></span></code></pre></div>
<p>The figure below shows direct estimates of infant mortality rates. Each panel depicts one county. The panels are ordered from top left to bottom right by the number of births in each county.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">swe_infant</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">deaths</span> <span class="op">/</span> <span class="va">births</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">county</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig05_bdef_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
</div>
<div class="section level3" number="2.2">
<h3 id="initial-model">
<span class="header-section-number">2.2</span> Initial model<a class="anchor" aria-label="anchor" href="#initial-model"></a>
</h3>
<p>Our model uses default settings for all priors and parameters.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mod_binom.html">mod_binom</a></span><span class="op">(</span><span class="va">deaths</span> <span class="op">~</span> <span class="va">county</span> <span class="op">+</span> <span class="va">time</span>,</span>
<span>                 data <span class="op">=</span> <span class="va">swe_infant</span>,</span>
<span>                 size <span class="op">=</span> <span class="va">births</span><span class="op">)</span></span>
<span><span class="va">mod</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     ------ Unfitted binomial model ------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    deaths ~ county + time</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                      size: births</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         term  prior along n_par n_par_free</span></span>
<span><span class="co">#&gt;  (Intercept) NFix()     -     1          1</span></span>
<span><span class="co">#&gt;       county    N()     -    21         21</span></span>
<span><span class="co">#&gt;         time   RW()  time    21         21</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  disp: mean = 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  n_draw var_time</span></span>
<span><span class="co">#&gt;    1000     time</span></span></code></pre></div>
<p>In this model, deaths in county <span class="math inline">\(c\)</span> during year <span class="math inline">\(t\)</span>, denoted <span class="math inline">\(y_{ct}\)</span>, are drawn from a binomial distribution with probability <span class="math inline">\(\pi_{ct}\)</span> and trials <span class="math inline">\(w_{ct}\)</span>,
<span class="math display">\[\begin{equation}
  y_{ct} \sim \text{binomial}(\pi_{ct}, w_{ct}).
\end{equation}\]</span>
The probability <span class="math inline">\(\pi_{ct}\)</span> is in turn drawn from a beta distribution, with expected value <span class="math inline">\(\mu_{ct}\)</span> and dispersion parameter <span class="math inline">\(\xi\)</span>,
<span class="math display">\[\begin{equation}
  \pi_{ct} \sim \text{Beta}(\xi^{-1} \mu_{ct}, \xi^{-1}[1 - \mu_{ct}])
\end{equation}\]</span>
Expected value <span class="math inline">\(\mu_{ct}\)</span>, transformed on to a logit scale, depends on three terms: an intercept, a ‘county’ main effect, and a ‘time’ main effect,
<span class="math display">\[\begin{equation}
  \text{logit} \mu_{ct} = \beta^0 + \beta_c^{\mathcal{C}} + \beta_t^{\mathcal{T}}
\end{equation}\]</span>
Each of these terms has a prior. The intercept has a ‘normal-fixed’ prior,
<span class="math display">\[\begin{equation}
  \beta^0 \sim \text{N}(0, 1).
\end{equation}\]</span>
The county main effect has a ‘normal’ prior,
<span class="math display">\[\begin{align}
  \beta_c^{\mathcal{C}} &amp; \sim \text{N}(0, \tau_{\mathcal{C}}^2) \\
  \tau_{\mathcal{C}} &amp; \sim \text{N}^+(0, 1).
\end{align}\]</span>
The time main effect has a random walk prior,
<span class="math display">\[\begin{align}
  \beta_t^{\mathcal{T}} &amp; \sim \text{N}(\beta_{t-1}^{\mathcal{T}}, \tau_{\mathcal{C}}^2) \\
  \tau_{\mathcal{C}} &amp; \sim \text{N}^+(0, 1).
\end{align}\]</span>
Finally, the dispersion parameter <span class="math inline">\(\xi\)</span> has an expontial prior
<span class="math display">\[\begin{equation}
  \xi \sim \text{Exp}(1).
\end{equation}\]</span></p>
<blockquote>
<p><strong>BDEF Note</strong></p>
<p>This model is slightly different from the infant mortality model in BDEF. The intercept here has a <span class="math inline">\(\text{N}(0,1)\)</span> prior rather than <span class="math inline">\(\text{N}(0,10^2)\)</span>, and the time effect has a random walk prior rather than a local level prior. (Local level priors have not yet been implemented in <code>bage</code>.)</p>
</blockquote>
<p>We fit the model. Fitting in <code>bage</code> is a lot faster than fitting in <code>demest</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="va">mod</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Building log-posterior function...</span></span>
<span><span class="co">#&gt; Finding maximum...</span></span>
<span><span class="co">#&gt; Drawing values for hyper-parameters...</span></span>
<span><span class="va">mod</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     ------ Fitted binomial model ------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    deaths ~ county + time</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                      size: births</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         term  prior along n_par n_par_free std_dev</span></span>
<span><span class="co">#&gt;  (Intercept) NFix()     -     1          1       -</span></span>
<span><span class="co">#&gt;       county    N()     -    21         21    0.11</span></span>
<span><span class="co">#&gt;         time   RW()  time    21         21    0.18</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  disp: mean = 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  n_draw var_time optimizer</span></span>
<span><span class="co">#&gt;    1000     time    nlminb</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  time_total time_max time_draw iter converged                    message</span></span>
<span><span class="co">#&gt;        0.64     0.36      0.22   14      TRUE   relative convergence (4)</span></span></code></pre></div>
</div>
<div class="section level3" number="2.3">
<h3 id="extracting-parameter-estimates">
<span class="header-section-number">2.3</span> Extracting parameter estimates<a class="anchor" aria-label="anchor" href="#extracting-parameter-estimates"></a>
</h3>
<p>We extract the rates estimates.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aug_init</span> <span class="op">&lt;-</span> <span class="va">mod</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">aug_init</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 441 × 7</span></span></span>
<span><span class="co">#&gt;    county     time births deaths .observed                 .fitted</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Stockholm  <span style="text-decoration: underline;">1</span>995  <span style="text-decoration: underline;">22</span>626     96   0.004<span style="text-decoration: underline;">24</span> 0.0038 (0.0033, 0.0044)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Stockholm  <span style="text-decoration: underline;">1</span>996  <span style="text-decoration: underline;">21</span>354     74   0.003<span style="text-decoration: underline;">47</span>   0.0035 (0.003, 0.004)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Stockholm  <span style="text-decoration: underline;">1</span>997  <span style="text-decoration: underline;">20</span>646     62   0.003<span style="text-decoration: underline;">00</span> 0.0032 (0.0027, 0.0037)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Stockholm  <span style="text-decoration: underline;">1</span>998  <span style="text-decoration: underline;">20</span>815     81   0.003<span style="text-decoration: underline;">89</span>  0.0034 (0.0029, 0.004)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Stockholm  <span style="text-decoration: underline;">1</span>999  <span style="text-decoration: underline;">20</span>863     68   0.003<span style="text-decoration: underline;">26</span> 0.0031 (0.0027, 0.0037)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Stockholm  <span style="text-decoration: underline;">2</span>000  <span style="text-decoration: underline;">21</span>837     75   0.003<span style="text-decoration: underline;">43</span> 0.0032 (0.0028, 0.0037)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Stockholm  <span style="text-decoration: underline;">2</span>001  <span style="text-decoration: underline;">22</span>622     68   0.003<span style="text-decoration: underline;">01</span> 0.0031 (0.0027, 0.0036)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Stockholm  <span style="text-decoration: underline;">2</span>002  <span style="text-decoration: underline;">24</span>084     70   0.002<span style="text-decoration: underline;">91</span> 0.0029 (0.0026, 0.0034)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Stockholm  <span style="text-decoration: underline;">2</span>003  <span style="text-decoration: underline;">25</span>028     67   0.002<span style="text-decoration: underline;">68</span> 0.0028 (0.0024, 0.0032)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Stockholm  <span style="text-decoration: underline;">2</span>004  <span style="text-decoration: underline;">25</span>779     64   0.002<span style="text-decoration: underline;">48</span>  0.0026 (0.0023, 0.003)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 431 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: .expected &lt;rdbl&lt;1000&gt;&gt;</span></span></span></code></pre></div>
<p>We use function <code><a href="https://bayesiandemography.github.io/rvec/reference/draws_ci.html" class="external-link">draws_ci()</a></code> from package <strong>rvec</strong> to calculate 95% credible intervals.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aug_init</span> <span class="op">&lt;-</span> <span class="va">aug_init</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://bayesiandemography.github.io/rvec/reference/draws_ci.html" class="external-link">draws_ci</a></span><span class="op">(</span><span class="va">.fitted</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">aug_init</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 441 × 10</span></span></span>
<span><span class="co">#&gt;    county     time births deaths .observed                 .fitted</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Stockholm  <span style="text-decoration: underline;">1</span>995  <span style="text-decoration: underline;">22</span>626     96   0.004<span style="text-decoration: underline;">24</span> 0.0038 (0.0033, 0.0044)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Stockholm  <span style="text-decoration: underline;">1</span>996  <span style="text-decoration: underline;">21</span>354     74   0.003<span style="text-decoration: underline;">47</span>   0.0035 (0.003, 0.004)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Stockholm  <span style="text-decoration: underline;">1</span>997  <span style="text-decoration: underline;">20</span>646     62   0.003<span style="text-decoration: underline;">00</span> 0.0032 (0.0027, 0.0037)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Stockholm  <span style="text-decoration: underline;">1</span>998  <span style="text-decoration: underline;">20</span>815     81   0.003<span style="text-decoration: underline;">89</span>  0.0034 (0.0029, 0.004)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Stockholm  <span style="text-decoration: underline;">1</span>999  <span style="text-decoration: underline;">20</span>863     68   0.003<span style="text-decoration: underline;">26</span> 0.0031 (0.0027, 0.0037)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Stockholm  <span style="text-decoration: underline;">2</span>000  <span style="text-decoration: underline;">21</span>837     75   0.003<span style="text-decoration: underline;">43</span> 0.0032 (0.0028, 0.0037)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Stockholm  <span style="text-decoration: underline;">2</span>001  <span style="text-decoration: underline;">22</span>622     68   0.003<span style="text-decoration: underline;">01</span> 0.0031 (0.0027, 0.0036)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Stockholm  <span style="text-decoration: underline;">2</span>002  <span style="text-decoration: underline;">24</span>084     70   0.002<span style="text-decoration: underline;">91</span> 0.0029 (0.0026, 0.0034)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Stockholm  <span style="text-decoration: underline;">2</span>003  <span style="text-decoration: underline;">25</span>028     67   0.002<span style="text-decoration: underline;">68</span> 0.0028 (0.0024, 0.0032)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Stockholm  <span style="text-decoration: underline;">2</span>004  <span style="text-decoration: underline;">25</span>779     64   0.002<span style="text-decoration: underline;">48</span>  0.0026 (0.0023, 0.003)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 431 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 4 more variables: .expected &lt;rdbl&lt;1000&gt;&gt;, .fitted.lower &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   .fitted.mid &lt;dbl&gt;, .fitted.upper &lt;dbl&gt;</span></span></span></code></pre></div>
<p>And we graph the results.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">aug_init</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">county</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.fitted.lower</span>,</span>
<span>                  ymax <span class="op">=</span> <span class="va">.fitted.upper</span><span class="op">)</span>,</span>
<span>              fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.fitted.mid</span><span class="op">)</span>,</span>
<span>            color <span class="op">=</span> <span class="st">"darkblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.observed</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>         size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig05_bdef_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<p><code><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components()</a></code> returns values for hyper-parameters.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comp_init</span> <span class="op">&lt;-</span> <span class="va">mod</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">comp_init</span>  </span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 46 × 4</span></span></span>
<span><span class="co">#&gt;    term        component level                           .fitted</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                      <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> (Intercept) effect    (Intercept)           -2.7 (-4.1, -1.4)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> county      effect    Stockholm          -0.16 (-0.25, -0.07)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> county      effect    Vastra Gotaland -0.095 (-0.18, -0.0054)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> county      effect    Skane            -0.099 (-0.2, 0.00067)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> county      effect    Ostergotland        -0.01 (-0.14, 0.11)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> county      effect    Jonkoping           0.013 (-0.12, 0.14)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> county      effect    Uppsala            0.0053 (-0.13, 0.13)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> county      effect    Orebro              0.07 (-0.055, 0.22)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> county      effect    Dalarna              0.04 (-0.09, 0.17)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> county      effect    Norrbotten           0.17 (0.026, 0.31)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 36 more rows</span></span></span></code></pre></div>
<p>With help from some tidyverse functions we can extract and graph the intercept,</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">intercept</span> <span class="op">&lt;-</span> <span class="va">comp_init</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"(Intercept)"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://bayesiandemography.github.io/rvec/reference/draws_ci.html" class="external-link">draws_ci</a></span><span class="op">(</span><span class="va">.fitted</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">intercept</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">level</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_pointrange</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">.fitted.lower</span>,</span>
<span>                      x <span class="op">=</span> <span class="va">.fitted.mid</span>,</span>
<span>                      xmax <span class="op">=</span> <span class="va">.fitted.upper</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig05_bdef_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<p>the county effect,</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">county_effect</span> <span class="op">&lt;-</span> <span class="va">comp_init</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"county"</span>,</span>
<span>         <span class="va">component</span> <span class="op">==</span> <span class="st">"effect"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>county <span class="op">=</span> <span class="va">level</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://bayesiandemography.github.io/rvec/reference/draws_ci.html" class="external-link">draws_ci</a></span><span class="op">(</span><span class="va">.fitted</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">county_effect</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">county</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_pointrange</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">.fitted.lower</span>,</span>
<span>                      x <span class="op">=</span> <span class="va">.fitted.mid</span>,</span>
<span>              xmax <span class="op">=</span> <span class="va">.fitted.upper</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig05_bdef_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<p>and the time effect.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time_effect</span> <span class="op">&lt;-</span> <span class="va">comp_init</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"time"</span>,</span>
<span>         <span class="va">component</span> <span class="op">==</span> <span class="st">"effect"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">level</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://bayesiandemography.github.io/rvec/reference/draws_ci.html" class="external-link">draws_ci</a></span><span class="op">(</span><span class="va">.fitted</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">time_effect</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.fitted.lower</span>,</span>
<span>                 ymax <span class="op">=</span> <span class="va">.fitted.upper</span><span class="op">)</span>,</span>
<span>          fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.fitted.mid</span><span class="op">)</span>,</span>
<span>            color <span class="op">=</span> <span class="st">"darkblue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig05_bdef_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
<p>The county effect and time effect each have <code>sd</code> parameters, which we also extract.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comp_init</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">component</span> <span class="op">==</span> <span class="st">"hyper"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 4</span></span></span>
<span><span class="co">#&gt;   term   component level             .fitted</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> county hyper     sd     0.14 (0.085, 0.22)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> time   hyper     sd    0.066 (0.037, 0.11)</span></span></code></pre></div>
</div>
<div class="section level3" number="2.4">
<h3 id="an-aside-on-weakly-identified-effects">
<span class="header-section-number">2.4</span> An aside on weakly-identified effects<a class="anchor" aria-label="anchor" href="#an-aside-on-weakly-identified-effects"></a>
</h3>
<p>The intercept and time effects from our model both have wide credible intervals. This reflects the fact that they are only weakly identified by the model and data. Adding a small quantity to each element of the time effect, and subtracting the same quantity from the intercept, would make no difference at all to the predictions of the model, and make only a tiny difference to the posterior probabilities.</p>
<p>In <code>demest</code> we deal with the weak identification by standardizing the estimates. Standardization can, however, introduce new complications, and we have not implemented it in <code>bage</code>.</p>
<p>When an analysis is focused only on lowest-level rates, probabilities, or means, and higher-level parameters such as time effects are just a means to an end, weak identification rarely causes any problems. If, however, the higher-level parameters are of interest, it may be helpful to experiment with non-default values for parameters. In the model here, for instance, setting the <code>sd</code> parameter for the <code><a href="../reference/RW.html">RW()</a></code> prior to 0 fixes the first value of the time effect to 0, leading to a more strongly-identified time effect.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_ident</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mod_binom.html">mod_binom</a></span><span class="op">(</span><span class="va">deaths</span> <span class="op">~</span> <span class="va">county</span> <span class="op">+</span> <span class="va">time</span>,</span>
<span>                       data <span class="op">=</span> <span class="va">swe_infant</span>,</span>
<span>               size <span class="op">=</span> <span class="va">births</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_prior.html">set_prior</a></span><span class="op">(</span><span class="va">time</span> <span class="op">~</span> <span class="fu"><a href="../reference/RW.html">RW</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Building log-posterior function...</span></span>
<span><span class="co">#&gt; Finding maximum...</span></span>
<span><span class="co">#&gt; Drawing values for hyper-parameters...</span></span>
<span></span>
<span><span class="va">time_effect_ident</span> <span class="op">&lt;-</span> <span class="va">mod_ident</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"time"</span>,</span>
<span>         <span class="va">component</span> <span class="op">==</span> <span class="st">"effect"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">level</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://bayesiandemography.github.io/rvec/reference/draws_ci.html" class="external-link">draws_ci</a></span><span class="op">(</span><span class="va">.fitted</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">time_effect_ident</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.fitted.lower</span>,</span>
<span>                 ymax <span class="op">=</span> <span class="va">.fitted.upper</span><span class="op">)</span>,</span>
<span>          fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.fitted.mid</span><span class="op">)</span>,</span>
<span>            color <span class="op">=</span> <span class="st">"darkblue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig05_bdef_files/figure-html/unnamed-chunk-15-1.png" width="672"></p>
</div>
<div class="section level3" number="2.5">
<h3 id="replicate-data-check">
<span class="header-section-number">2.5</span> Replicate data check<a class="anchor" aria-label="anchor" href="#replicate-data-check"></a>
</h3>
<p>We use a replicate data check to see if, without a county-time interaction, the model is adequately representing cross-county variation in the downward trend in mortality.</p>
<p>Function <code><a href="../reference/replicate_data.html">replicate_data()</a></code> generates replicate datasets.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/replicate_data.html">replicate_data</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="va">rep_data</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 8,820 × 5</span></span></span>
<span><span class="co">#&gt;    .replicate county     time births deaths</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Original   Stockholm  <span style="text-decoration: underline;">1</span>995  <span style="text-decoration: underline;">22</span>626     96</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Original   Stockholm  <span style="text-decoration: underline;">1</span>996  <span style="text-decoration: underline;">21</span>354     74</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Original   Stockholm  <span style="text-decoration: underline;">1</span>997  <span style="text-decoration: underline;">20</span>646     62</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Original   Stockholm  <span style="text-decoration: underline;">1</span>998  <span style="text-decoration: underline;">20</span>815     81</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Original   Stockholm  <span style="text-decoration: underline;">1</span>999  <span style="text-decoration: underline;">20</span>863     68</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Original   Stockholm  <span style="text-decoration: underline;">2</span>000  <span style="text-decoration: underline;">21</span>837     75</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Original   Stockholm  <span style="text-decoration: underline;">2</span>001  <span style="text-decoration: underline;">22</span>622     68</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Original   Stockholm  <span style="text-decoration: underline;">2</span>002  <span style="text-decoration: underline;">24</span>084     70</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Original   Stockholm  <span style="text-decoration: underline;">2</span>003  <span style="text-decoration: underline;">25</span>028     67</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Original   Stockholm  <span style="text-decoration: underline;">2</span>004  <span style="text-decoration: underline;">25</span>779     64</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 8,810 more rows</span></span></span></code></pre></div>
<p>For each replicate, we calculate direct estimates of the infant mortality rates, fit a line through these estimates, and collect up the slope.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calculate_slope</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">rate</span> <span class="op">~</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="st">"time"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">slopes</span> <span class="op">&lt;-</span> <span class="va">rep_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="va">deaths</span> <span class="op">/</span> <span class="va">births</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">.replicate</span>, <span class="va">county</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">calculate_slope</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">slopes</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.replicate</span>, y <span class="op">=</span> <span class="va">slope</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_jitter.html" class="external-link">position_jitter</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig05_bdef_files/figure-html/unnamed-chunk-17-1.png" width="672"></p>
<p>The slopes from the original data (on the far left) have aboout the same level of variability as the slopes from the replicate data. The implication is that, even without a county-time interaction, the model is a satisfactory job of representing cross-county variability in the pace of decline.</p>
</div>
<div class="section level3" number="2.6">
<h3 id="summarizing-results-through-probabilities">
<span class="header-section-number">2.6</span> Summarizing results through probabilities<a class="anchor" aria-label="anchor" href="#summarizing-results-through-probabilities"></a>
</h3>
<p>We would like to calculate, for each combination of county and time, the probability that the underlying (super-population) infant mortality rate is less than 2.5 per 1000. The <code><a href="https://bayesiandemography.github.io/rvec/reference/prob.html" class="external-link">prob()</a></code> function from <strong>rvec</strong> makes this easy.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prob_25</span> <span class="op">&lt;-</span> <span class="va">aug_init</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="fu"><a href="https://bayesiandemography.github.io/rvec/reference/prob.html" class="external-link">prob</a></span><span class="op">(</span><span class="va">.fitted</span> <span class="op">&lt;</span> <span class="fl">0.0025</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">prob_25</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">prob</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">county</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig05_bdef_files/figure-html/unnamed-chunk-18-1.png" width="672"></p>
</div>
<div class="section level3" number="2.7">
<h3 id="forecast">
<span class="header-section-number">2.7</span> Forecast<a class="anchor" aria-label="anchor" href="#forecast"></a>
</h3>
<p>We forecast mortality rates through to 2025. By default, the <code><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast()</a></code> function returns output that looks like a return value from <code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code>. When <code>include_estimates</code> is `TRUE, the output includes historical values.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vals_forecast</span> <span class="op">&lt;-</span> <span class="va">mod</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fl">2016</span><span class="op">:</span><span class="fl">2025</span>,</span>
<span>           include_estimates <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; `components()` for past values...</span></span>
<span><span class="co">#&gt; `components()` for future values...</span></span>
<span><span class="co">#&gt; `augment()` for future values...</span></span>
<span><span class="co">#&gt; `augment()` for past values...</span></span>
<span><span class="va">vals_forecast</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 651 × 7</span></span></span>
<span><span class="co">#&gt;    county     time births deaths .observed                 .fitted</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Stockholm  <span style="text-decoration: underline;">1</span>995  <span style="text-decoration: underline;">22</span>626     96   0.004<span style="text-decoration: underline;">24</span> 0.0038 (0.0033, 0.0044)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Stockholm  <span style="text-decoration: underline;">1</span>996  <span style="text-decoration: underline;">21</span>354     74   0.003<span style="text-decoration: underline;">47</span>   0.0035 (0.003, 0.004)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Stockholm  <span style="text-decoration: underline;">1</span>997  <span style="text-decoration: underline;">20</span>646     62   0.003<span style="text-decoration: underline;">00</span> 0.0032 (0.0027, 0.0037)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Stockholm  <span style="text-decoration: underline;">1</span>998  <span style="text-decoration: underline;">20</span>815     81   0.003<span style="text-decoration: underline;">89</span>  0.0034 (0.0029, 0.004)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Stockholm  <span style="text-decoration: underline;">1</span>999  <span style="text-decoration: underline;">20</span>863     68   0.003<span style="text-decoration: underline;">26</span> 0.0031 (0.0027, 0.0037)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Stockholm  <span style="text-decoration: underline;">2</span>000  <span style="text-decoration: underline;">21</span>837     75   0.003<span style="text-decoration: underline;">43</span> 0.0032 (0.0028, 0.0037)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Stockholm  <span style="text-decoration: underline;">2</span>001  <span style="text-decoration: underline;">22</span>622     68   0.003<span style="text-decoration: underline;">01</span> 0.0031 (0.0027, 0.0036)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Stockholm  <span style="text-decoration: underline;">2</span>002  <span style="text-decoration: underline;">24</span>084     70   0.002<span style="text-decoration: underline;">91</span> 0.0029 (0.0026, 0.0034)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Stockholm  <span style="text-decoration: underline;">2</span>003  <span style="text-decoration: underline;">25</span>028     67   0.002<span style="text-decoration: underline;">68</span> 0.0028 (0.0024, 0.0032)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Stockholm  <span style="text-decoration: underline;">2</span>004  <span style="text-decoration: underline;">25</span>779     64   0.002<span style="text-decoration: underline;">48</span>  0.0026 (0.0023, 0.003)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 641 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: .expected &lt;rdbl&lt;1000&gt;&gt;</span></span></span></code></pre></div>
<p>In contrast to the all-defaults model in Chapter 11 of BDEF, the all-defaults model here does not yield exploding prediction intervals.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vals_forecast</span> <span class="op">&lt;-</span> <span class="va">vals_forecast</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://bayesiandemography.github.io/rvec/reference/draws_ci.html" class="external-link">draws_ci</a></span><span class="op">(</span><span class="va">.fitted</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">vals_forecast</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">county</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.fitted.lower</span>,</span>
<span>                  ymax <span class="op">=</span> <span class="va">.fitted.upper</span><span class="op">)</span>,</span>
<span>             fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.fitted.mid</span><span class="op">)</span>,</span>
<span>            color <span class="op">=</span> <span class="st">"darkblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.observed</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>         size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 210 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_point()`).</span></span></code></pre></div>
<p><img src="vig05_bdef_files/figure-html/unnamed-chunk-20-1.png" width="672"></p>
</div>
</div>
<div class="section level2" number="3">
<h2 id="life-expectancy-in-portugal">
<span class="header-section-number">3</span> Life expectancy in Portugal<a class="anchor" aria-label="anchor" href="#life-expectancy-in-portugal"></a>
</h2>
<p>TODO - write this!</p>
</div>
<div class="section level2" number="4">
<h2 id="health-expenditure-in-the-netherlands">
<span class="header-section-number">4</span> Health expenditure in the Netherlands<a class="anchor" aria-label="anchor" href="#health-expenditure-in-the-netherlands"></a>
</h2>
<p>TODO - write this!</p>
</div>
<div class="section level2" number="5">
<h2 id="internal-migration-in-iceland">
<span class="header-section-number">5</span> Internal migration in Iceland<a class="anchor" aria-label="anchor" href="#internal-migration-in-iceland"></a>
</h2>
<p>TODO - write this!</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by John Bryant, Junni Zhang.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
