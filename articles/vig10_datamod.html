<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>10. Data Models • bage</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="10. Data Models">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bage</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/vig01_intro.html">1. Overview</a></li>
    <li><a class="dropdown-item" href="../articles/vig02_math.html">2. Mathematical Details</a></li>
    <li><a class="dropdown-item" href="../articles/vig03_priors.html">3. Priors</a></li>
    <li><a class="dropdown-item" href="../articles/vig04_svd.html">4. Singular Value Decomposition</a></li>
    <li><a class="dropdown-item" href="../articles/vig05_bdef.html">5. Examples from BDEF Book</a></li>
    <li><a class="dropdown-item" href="../articles/vig06_mortality.html">6. Modelling Mortality</a></li>
    <li><a class="dropdown-item" href="../articles/vig07_simulation.html">7. Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/vig08_workflow.html">8. Bayesian Workflow</a></li>
    <li><a class="dropdown-item" href="../articles/vig09_covariates.html">9. Covariates</a></li>
    <li><a class="dropdown-item" href="../articles/vig10_datamod.html">10. Data Models</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bayesiandemography/bage/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>10. Data Models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bayesiandemography/bage/blob/main/vignettes/vig10_datamod.Rmd" class="external-link"><code>vignettes/vig10_datamod.Rmd</code></a></small>
      <div class="d-none name"><code>vig10_datamod.Rmd</code></div>
    </div>

    
    
<div class="section level2" number="1">
<h2 id="introduction">
<span class="header-section-number">1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>By default, the Poisson, binomial, and normal models in <code>bage</code> assume that any measurement errors in the input data are small enough to be ignored. These models can, however, be extended to accommodate various types of measurement error. This is done by adding a “data model”—also referred to as a “measurement error model”—to the base model. The data models that have been implemented so far in <code>bage</code> are fairly generic: they aim to perform reasonably well on a wide range of applications, rather than performing optimally on any particular application. Future versions of <code>bage</code> will add some more specialised data models.</p>
<p>This vignette begins with an overview of the current menu of data models. It then shows how the simple models presented in the overview can be extended to deal with more complicated situations, and discusses forecasting and confidentialization.</p>
<p>The overview will use a model of births in a single Korean province in a single year. The input data is:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">births</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 9 × 3</span></span></span>
<span><span class="co">#&gt;   age   births  popn</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 10-14      0 <span style="text-decoration: underline;">27</span>084</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 15-19      9 <span style="text-decoration: underline;">25</span>322</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 20-24    110 <span style="text-decoration: underline;">23</span>935</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 25-29    912 <span style="text-decoration: underline;">28</span>936</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 30-34   <span style="text-decoration: underline;">2</span>547 <span style="text-decoration: underline;">30</span>964</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 35-39   <span style="text-decoration: underline;">1</span>235 <span style="text-decoration: underline;">31</span>611</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> 40-44    262 <span style="text-decoration: underline;">44</span>567</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> 45-49      6 <span style="text-decoration: underline;">41</span>774</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">9</span> 50-54      0 <span style="text-decoration: underline;">51</span>312</span></span></code></pre></div>
<p><img src="vig10_datamod_files/figure-html/unnamed-chunk-4-1.png"><!-- --></p>
<p>Our base model treats the input data as error free. We specify and fit the base model as follows.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bayesiandemography.github.io/bage/">bage</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">mod_base</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mod_pois.html">mod_pois</a></span><span class="op">(</span><span class="va">births</span> <span class="op">~</span> <span class="va">age</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">births</span>,</span>
<span>                     exposure <span class="op">=</span> <span class="va">popn</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Building log-posterior function...</span></span>
<span><span class="co">#&gt; Finding maximum...</span></span>
<span><span class="co">#&gt; Drawing values for hyper-parameters...</span></span>
<span><span class="va">mod_base</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     ------ Fitted Poisson model ------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    births ~ age</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  exposure: popn</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         term  prior along n_par n_par_free std_dev</span></span>
<span><span class="co">#&gt;  (Intercept) NFix()     -     1          1       -</span></span>
<span><span class="co">#&gt;          age   RW()   age     9          9    1.27</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  disp: mean = 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  n_draw var_age optimizer</span></span>
<span><span class="co">#&gt;    1000     age    nlminb</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  time_total time_max time_draw iter converged</span></span>
<span><span class="co">#&gt;        0.84     0.04      0.05   15      TRUE</span></span>
<span><span class="co">#&gt;                                            message</span></span>
<span><span class="co">#&gt;    both X-convergence and relative convergence (5)</span></span></code></pre></div>
<p>The base model yields the following estimates for birth rates:</p>
<p><img src="vig10_datamod_files/figure-html/unnamed-chunk-6-1.png"><!-- --></p>
</div>
<div class="section level2" number="2">
<h2 id="current-menu-of-data-models">
<span class="header-section-number">2</span> Current menu of data models<a class="anchor" aria-label="anchor" href="#current-menu-of-data-models"></a>
</h2>
<div class="section level3" number="2.1">
<h3 id="overview">
<span class="header-section-number">2.1</span> Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h3>
<p><code>bage</code> currently implements five generic data models:</p>
<table class="table">
<colgroup>
<col width="13%">
<col width="52%">
<col width="11%">
<col width="12%">
<col width="11%">
</colgroup>
<thead><tr class="header">
<th align="left"><strong>Model</strong></th>
<th align="left"><strong>Assumptions about measurement error</strong></th>
<th align="left"><strong>Poisson</strong></th>
<th align="left"><strong>Binomial</strong></th>
<th align="left"><strong>Normal</strong></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Miscount</td>
<td align="left">Reported outcome has undercount and overcount</td>
<td align="left">Yes</td>
<td align="left">No</td>
<td align="left">No</td>
</tr>
<tr class="even">
<td align="left">Undercount</td>
<td align="left">Reported outcome has undercount</td>
<td align="left">Yes</td>
<td align="left">Yes</td>
<td align="left">No</td>
</tr>
<tr class="odd">
<td align="left">Overcount</td>
<td align="left">Reported outcome has overcount</td>
<td align="left">Yes</td>
<td align="left">No</td>
<td align="left">No</td>
</tr>
<tr class="even">
<td align="left">Noise</td>
<td align="left">Reported outcome unbiased, but with positive and negative measurement errors</td>
<td align="left">Yes*</td>
<td align="left">No</td>
<td align="left">Yes</td>
</tr>
<tr class="odd">
<td align="left">Exposure</td>
<td align="left">Reported exposure unbiased, but with positive and negative measurement errors</td>
<td align="left">Yes*</td>
<td align="left">No</td>
<td align="left">No</td>
</tr>
</tbody>
</table>
<p>*Models with no dispersion term for rates.</p>
</div>
<div class="section level3" number="2.2">
<h3 id="undercount-model">
<span class="header-section-number">2.2</span> Undercount model<a class="anchor" aria-label="anchor" href="#undercount-model"></a>
</h3>
<p>The undercount data model assumes that each event or person in the target population has a non-zero chance of being left out of the reported total. In other words, inclusion probabilities are less than 1. The user supplies a prior for inclusion probabilities, which is parameterized using means and dispersions, with means restricted to values between 0 and 1.</p>
<p>More precisely, the undercount data model is
<span class="math display">\[\begin{align}
  y_i^{\text{obs}} &amp; \sim \text{Binomial}(y_i^{\text{true}}, \pi_{g[i]}) \\
  \pi_g &amp; \sim \text{Beta}\left( \frac{m_g}{d_g}, \frac{1-m_g}{d_g} \right)
\end{align}\]</span>
where</p>
<ul>
<li>
<span class="math inline">\(y_i^{\text{obs}}\)</span> is the observed value for the outcome variable in cell <span class="math inline">\(i\)</span>;</li>
<li>
<span class="math inline">\(y_i^{\text{true}}\)</span> is the true value for the outcome variable in cell <span class="math inline">\(i\)</span>;</li>
<li>
<span class="math inline">\(\pi_{g[i]}\)</span> is the inclusion probability for cell <span class="math inline">\(i\)</span> (which may be shared across multiple cells);</li>
<li>
<span class="math inline">\(m_g\)</span> is the mean for the prior governing <span class="math inline">\(\pi_g\)</span>; and</li>
<li>
<span class="math inline">\(d_g\)</span> is the dispersion for the prior governing <span class="math inline">\(\pi_g\)</span>.</li>
</ul>
<p>We assume, for the moment, that all cells share the same coverage probability, which is drawn from a distribution with mean 0.8 and dispersion 0.02.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prob_under</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">0.8</span>, disp <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span></code></pre></div>
<p>We use function `set_datamod_undercount to add an ‘undercount’ data model to our original base model, and then fit the new combined model</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_under</span> <span class="op">&lt;-</span> <span class="va">mod_base</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_datamod_undercount.html">set_datamod_undercount</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="va">prob_under</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">mod_under</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     ------ Fitted Poisson model ------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    births ~ age</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  exposure: popn</span></span>
<span><span class="co">#&gt;                data model: undercount</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         term  prior along n_par n_par_free std_dev</span></span>
<span><span class="co">#&gt;  (Intercept) NFix()     -     1          1       -</span></span>
<span><span class="co">#&gt;          age   RW()   age     9          9    1.19</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  disp: mean = 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  n_draw var_age optimizer</span></span>
<span><span class="co">#&gt;    1000     age    nlminb</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  time_total time_max time_draw iter converged                    message</span></span>
<span><span class="co">#&gt;        0.05     0.02      0.01   13      TRUE   relative convergence (4)</span></span></code></pre></div>
<p>Calling <code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code> on the fitted model yields the usual estimates of the birth rate, shown in the <code>.fitted</code> and <code>.expected</code> columns, but also estimates of true births, in the <code>.births</code> column:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_under</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Adding variable `.births` with true values for `births`.</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 9 × 7</span></span></span>
<span><span class="co">#&gt;   age   births           .births  popn .observed                    .fitted</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 10-14      0          0 (0, 1) <span style="text-decoration: underline;">27</span>084  0          3e-06 (1.8e-11, 8.8e-05)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 15-19      9        11 (9, 16) <span style="text-decoration: underline;">25</span>322  0.000<span style="text-decoration: underline;">355</span> 0.00043 (0.00021, 0.00078)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 20-24    110    138 (120, 166) <span style="text-decoration: underline;">23</span>935  0.004<span style="text-decoration: underline;">60</span>     0.0058 (0.0045, 0.0073)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 25-29    912 1139 (1012, 1352) <span style="text-decoration: underline;">28</span>936  0.031<span style="text-decoration: underline;">5</span>         0.039 (0.035, 0.047)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 30-34   <span style="text-decoration: underline;">2</span>547 3182 (2841, 3745) <span style="text-decoration: underline;">30</span>964  0.082<span style="text-decoration: underline;">3</span>            0.1 (0.091, 0.12)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 35-39   <span style="text-decoration: underline;">1</span>235 1540 (1369, 1818) <span style="text-decoration: underline;">31</span>611  0.039<span style="text-decoration: underline;">1</span>         0.049 (0.043, 0.058)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> 40-44    262    327 (290, 393) <span style="text-decoration: underline;">44</span>567  0.005<span style="text-decoration: underline;">88</span>      0.0074 (0.0062, 0.009)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> 45-49      6         7 (6, 11) <span style="text-decoration: underline;">41</span>774  0.000<span style="text-decoration: underline;">144</span> 0.00018 (6.8e-05, 0.00037)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">9</span> 50-54      0          0 (0, 1) <span style="text-decoration: underline;">51</span>312  0        1.2e-06 (3.7e-12, 4.2e-05)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: .expected &lt;rdbl&lt;1000&gt;&gt;</span></span></span></code></pre></div>
<p>Estimated birth rates from the undercount model are higher than estimated birth rates from the base model, since the undercount model assumes that reported births understate true births.</p>
<p><img src="vig10_datamod_files/figure-html/unnamed-chunk-10-1.png"><!-- --></p>
<p>Here are the estimates of births underlying the baseline and undercount models:
<img src="vig10_datamod_files/figure-html/unnamed-chunk-11-1.png"><!-- --></p>
<p>The estimated coverage probability can be extracted using function <code><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_under</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"datamod"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 4</span></span></span>
<span><span class="co">#&gt;   term    component level         .fitted</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> datamod prob      prob  0.8 (0.68, 0.9)</span></span></code></pre></div>
</div>
<div class="section level3" number="2.3">
<h3 id="overcount-model">
<span class="header-section-number">2.3</span> Overcount model<a class="anchor" aria-label="anchor" href="#overcount-model"></a>
</h3>
<p>The overcount data model assumes that reported outcomes include counts of people or events that do not in fact come from the true population, or that have been double-counted. The expected size of the overcount equals the expected size of the true count, multiplied by an overcoverage rate.</p>
<p>More precisely,
<span class="math display">\[\begin{align}
  y_i^{\text{obs}} &amp; = y_i^{\text{true}} + \epsilon_i \\
  \epsilon_i &amp; \sim \text{Poisson}( \kappa_{g[i]}  \gamma_i w_i) \\
  \kappa_g &amp; \sim \text{Gamma}\left(\frac{1}{d_g}, \frac{1}{m_g d_g} \right)
\end{align}\]</span>
where</p>
<ul>
<li>
<span class="math inline">\(y_i^{\text{obs}}\)</span> is the observed value for the outcome variable in cell <span class="math inline">\(i\)</span>;</li>
<li>
<span class="math inline">\(y_i^{\text{true}}\)</span> is the true value for the outcome variable in cell <span class="math inline">\(i\)</span>;</li>
<li>
<span class="math inline">\(\gamma_i\)</span> is the underlying rate for outcome <span class="math inline">\(y_i^{\text{true}}\)</span>;</li>
<li>
<span class="math inline">\(w_i\)</span> is exposure in cell <span class="math inline">\(i\)</span>;</li>
<li>
<span class="math inline">\(\kappa_{g[i]}\)</span> is the overcoverage rate for cell <span class="math inline">\(i\)</span> (which may be shared across multiple cells);</li>
<li>
<span class="math inline">\(m_g\)</span> is the mean for the prior governing <span class="math inline">\(\kappa_g\)</span>; and</li>
<li>
<span class="math inline">\(d_g\)</span> is the dispersion for the prior governing <span class="math inline">\(\kappa_g\)</span>.</li>
</ul>
<p>For the moment, we assume that all cells have the same overcoverage rate, which is drawn from a distribution with mean 0.1 and dispersion 0.05.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rate_over</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">0.1</span>, disp <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span></code></pre></div>
<p>We specify the overcount model using function <code><a href="../reference/set_datamod_overcount.html">set_datamod_overcount()</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_over</span> <span class="op">&lt;-</span> <span class="va">mod_base</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_datamod_overcount.html">set_datamod_overcount</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="va">rate_over</span><span class="op">)</span></span></code></pre></div>
<p>Adding an overcount data model produces birth rate estimates that are lower than those of the base model, since the reported birth counts are assumed to be too high.</p>
<p><img src="vig10_datamod_files/figure-html/unnamed-chunk-15-1.png"><!-- --></p>
</div>
<div class="section level3" number="2.4">
<h3 id="miscount-model">
<span class="header-section-number">2.4</span> Miscount model<a class="anchor" aria-label="anchor" href="#miscount-model"></a>
</h3>
<p>The miscount data model is a combination of the undercount and overcount models. It assumes that the reported outcome includes some undercount, and some overcount. The model is
<span class="math display">\[\begin{align}
  y_i^{\text{obs}} &amp; = u_i + v_i \\
  u_i &amp; \sim \text{Binomial}(y_i^{\text{true}}, \pi_{g[i]}) \\
  v_i &amp; \sim \text{Poisson}( \kappa_{h[i]}  \gamma_i w_i) \\
  \pi_g &amp; \sim \text{Beta}\left( \frac{m_g}{d_g}, \frac{1-m_g}{d_g} \right) \\
  \kappa_h &amp; \sim \text{Gamma}\left(\frac{1}{d_h}, \frac{1}{m_h d_h} \right)
\end{align}\]</span>
where the variables have the same definitions as they do in the undercount and overcount models.</p>
<p>We need to specify priors for inclusion probabilities and overcoverage rates. We re-use the priors from the previous models.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_mis</span> <span class="op">&lt;-</span> <span class="va">mod_base</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_datamod_miscount.html">set_datamod_miscount</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="va">prob_under</span>,</span>
<span>                       rate <span class="op">=</span> <span class="va">rate_over</span><span class="op">)</span></span></code></pre></div>
<p>Our choice of priors implies more undercoverage than overcoverage, so our estimated birth rates, and estimated birth counts, are higher than those of the baseline model.</p>
<p><img src="vig10_datamod_files/figure-html/unnamed-chunk-17-1.png"><!-- --></p>
<p>We use <code><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components()</a></code> to extract estimates of the inclusion probability and overcount rate.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_mis</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"datamod"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 4</span></span></span>
<span><span class="co">#&gt;   term    component level             .fitted</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> datamod prob      prob     0.8 (0.67, 0.89)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> datamod rate      rate  0.099 (0.063, 0.15)</span></span></code></pre></div>
</div>
<div class="section level3" number="2.5">
<h3 id="noise-model">
<span class="header-section-number">2.5</span> Noise model<a class="anchor" aria-label="anchor" href="#noise-model"></a>
</h3>
<p>The noise model assumes that the reported outcome equals the true outcome plus some noise,</p>
<p><span class="math display">\[\begin{equation}
  y_i^{\text{obs}} = y_i^{\text{true}} + \epsilon_i.
\end{equation}\]</span></p>
<p>The noise is assumed have an expected value of zero. Its distribution depends on the base model the noise data model is being applied to. If the base model is normal, then the noise is assumed to have a normal distribution,
<span class="math display">\[\begin{equation}
  \epsilon_i \sim \text{N}(0, s_{g[i]}^2)
\end{equation}\]</span></p>
<p>If the base model is Poisson, then the noise is assumed to have a symmetric Skellam distribution,
<span class="math display">\[\begin{equation}
  \epsilon_i \sim \text{Skellam}(m_{g[i]}, m_{g[i]})
\end{equation}\]</span>
where <span class="math inline">\(m_g = \frac{1}{2} s_g^2\)</span>.</p>
<p>The Skellam distribution is derived from the Poisson distribution. If <span class="math inline">\(x_1 \sim \text{Poisson}(\mu_1)\)</span>, <span class="math inline">\(x_2 \sim \text{Poisson}(\mu_2)\)</span>, and <span class="math inline">\(y = x_1 + x_2\)</span>, then <span class="math inline">\(y \sim \text{Skellam}(\mu_1, \mu_2)\)</span>. If the two Poisson variates have the same expected value, than the Skellam distribution is symmetric, with single parameter <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\text{E}[y] = 0\)</span> and <span class="math inline">\(\text{var}[y] = 2 \mu\)</span>.</p>
<p>Note that unlike the undercount, overcount, and miscount data models, the noise data model has no unknown parameters.</p>
<p>To use the noise data model with a Poisson model, we need to set dispersion in the Poisson model to 0. Function <code><a href="../reference/set_datamod_noise.html">set_datamod_noise()</a></code> will do this for us, but it is good practice to make the change explicit:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_noise</span> <span class="op">&lt;-</span> <span class="va">mod_base</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_disp.html">set_disp</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_datamod_noise.html">set_datamod_noise</a></span><span class="op">(</span>s <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p>Fitting this model yields the following estimates.
<img src="vig10_datamod_files/figure-html/unnamed-chunk-20-1.png"><!-- --></p>
<p>If the outcome variable is subject to known biases, then measurement errors cannot be assumed to have mean zero. Before the noise data model can be used, the outcome variable must be de-biased, by subtracting estimates of the bias.</p>
</div>
<div class="section level3" number="2.6">
<h3 id="exposure-model">
<span class="header-section-number">2.6</span> Exposure model<a class="anchor" aria-label="anchor" href="#exposure-model"></a>
</h3>
<p>In some applications, the exposure variable has bigger measurement errors than the outcome variable. <code>bage</code> has an exposure data model to be used with Poisson base models.</p>
<p>The model is</p>
<p><span class="math display">\[\begin{equation}
  w_i^{\text{obs}} \sim \text{InvGamma}(2 + d_{g[i]}^{-1}, [1 + d_{g[i]}^{-1}] w_i^{\text{true}})
\end{equation}\]</span></p>
<p>where
- <span class="math inline">\(w_i^{\text{obs}}\)</span> is the observed value for exposure in cell <span class="math inline">\(i\)</span>;
- <span class="math inline">\(w_i^{\text{true}}\)</span> is the true value for exposure in cell <span class="math inline">\(i\)</span>;
- <span class="math inline">\(w_i\)</span> is exposure in cell <span class="math inline">\(i\)</span>; and
- <span class="math inline">\(d_{g[i]}\)</span> is the dispersion parameter for cell <span class="math inline">\(i\)</span> (which may be shared across multiple cells).</p>
<p>The model contains no unknown parameters. Under the model
<span class="math display">\[\begin{align}
  E[w_i^{\text{obs}} \mid w_i^{\text{true}}] &amp; =  w_i^{\text{true}} \\
  \text{var}[w_i^{\text{obs}} \mid w_i^{\text{true}}] &amp; = d_{g[i]} ( w_i^{\text{true}})^2 \\
  \text{cv}[w_i^{\text{obs}} \mid w_i^{\text{true}}] &amp; = \sqrt{d_{g[i]}}
\end{align}\]</span>
where ‘cv’ is the coefficient of variation, defined as the standard deviation, divided by the mean.</p>
<p>The exposure data model is specified using the cv. As with the noise data model, dispersion in the base model must be set to 0.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_expose</span> <span class="op">&lt;-</span> <span class="va">mod_base</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_disp.html">set_disp</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_datamod_exposure.html">set_datamod_exposure</a></span><span class="op">(</span>cv <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span></code></pre></div>
<p>Along with estimates of birth rates, the model also yields estimates of the true population.</p>
<p><img src="vig10_datamod_files/figure-html/unnamed-chunk-22-1.png"><!-- --></p>
</div>
</div>
<div class="section level2" number="3">
<h2 id="more-complicated-error-specifications">
<span class="header-section-number">3</span> More complicated error specifications<a class="anchor" aria-label="anchor" href="#more-complicated-error-specifications"></a>
</h2>
<p>In full-sized applications, we generally want inclusion probabilities, coverage rates, standard deviations, and coefficients of variation to vary across dimensions such as age, sex, and time. The data models implemented in <code>bage</code> allow this sort of variation.</p>
<p>We illustrate the use of varying data model parameters using a slightly extended version of our births model. We use a new dataset that includes a time variable:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">births_time</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 27 × 4</span></span></span>
<span><span class="co">#&gt;    age    time births  popn</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 10-14  <span style="text-decoration: underline;">2</span>021      0 <span style="text-decoration: underline;">27</span>208</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 10-14  <span style="text-decoration: underline;">2</span>022      0 <span style="text-decoration: underline;">27</span>185</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 10-14  <span style="text-decoration: underline;">2</span>023      0 <span style="text-decoration: underline;">27</span>084</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 15-19  <span style="text-decoration: underline;">2</span>021      3 <span style="text-decoration: underline;">25</span>039</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 15-19  <span style="text-decoration: underline;">2</span>022     16 <span style="text-decoration: underline;">25</span>276</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 15-19  <span style="text-decoration: underline;">2</span>023      9 <span style="text-decoration: underline;">25</span>322</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 20-24  <span style="text-decoration: underline;">2</span>021    178 <span style="text-decoration: underline;">29</span>008</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 20-24  <span style="text-decoration: underline;">2</span>022    120 <span style="text-decoration: underline;">26</span>201</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 20-24  <span style="text-decoration: underline;">2</span>023    110 <span style="text-decoration: underline;">23</span>935</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 25-29  <span style="text-decoration: underline;">2</span>021   <span style="text-decoration: underline;">1</span>212 <span style="text-decoration: underline;">30</span>826</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 17 more rows</span></span></span></code></pre></div>
<p>We create a new prior for inclusion probabilities where the mean and dispersion vary over time:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prob_under_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2021</span>, <span class="fl">2022</span>, <span class="fl">2023</span><span class="op">)</span>,</span>
<span>                              mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.99</span>, <span class="fl">0.8</span>,  <span class="fl">0.99</span><span class="op">)</span>,</span>
<span>                                    disp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.02</span>, <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We implement one model with the old time-constant prior, and one with the new time-varying prior.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_timeconst</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mod_pois.html">mod_pois</a></span><span class="op">(</span><span class="va">births</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">time</span>,</span>
<span>                          data <span class="op">=</span> <span class="va">births_time</span>,</span>
<span>                                exposure <span class="op">=</span> <span class="va">popn</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_datamod_undercount.html">set_datamod_undercount</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="va">prob_under</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod_timevarying</span> <span class="op">&lt;-</span> <span class="va">mod_timeconst</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_datamod_undercount.html">set_datamod_undercount</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="va">prob_under_time</span><span class="op">)</span></span>
<span><span class="co">#&gt; → Replacing existing <span style="color: #0000BB;">"undercount"</span> data model with new <span style="color: #0000BB;">"undercount"</span> data model</span></span></code></pre></div>
<p>As we would expect, these two models give different results.</p>
<p><img src="vig10_datamod_files/figure-html/unnamed-chunk-27-1.png"><!-- --></p>
<p>Data model parameters can vary across more than one dimension. We set up a prior that varies across age and time. Rather than using different inclusion probabilities for every age group, however, we use one set for people aged 10-34, and one for people aged 35+. To implement this, we need to create a new, aggregated age group.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">births_time</span> <span class="op">&lt;-</span> <span class="va">births_time</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>agegp <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">age</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"10-14"</span>, <span class="st">"15-19"</span>,</span>
<span>                                    <span class="st">"20-24"</span>, <span class="st">"25-29"</span>,</span>
<span>                                    <span class="st">"30-34"</span><span class="op">)</span>,</span>
<span>                         <span class="st">"10-34"</span>,</span>
<span>                         <span class="st">"35+"</span><span class="op">)</span><span class="op">)</span>                             </span>
<span></span>
<span><span class="va">prob_under_agetime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  time <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2021</span>,    <span class="fl">2022</span>,    <span class="fl">2023</span>,    <span class="fl">2021</span>,  <span class="fl">2022</span>,  <span class="fl">2023</span><span class="op">)</span>,</span>
<span>  agegp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"10-34"</span>, <span class="st">"10-34"</span>, <span class="st">"10-34"</span>, <span class="st">"35+"</span>, <span class="st">"35+"</span>, <span class="st">"35+"</span><span class="op">)</span>,</span>
<span>  mean <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span>,    <span class="fl">0.95</span>,    <span class="fl">0.95</span>,    <span class="fl">0.95</span>,  <span class="fl">0.5</span>,  <span class="fl">0.95</span><span class="op">)</span>,</span>
<span>  disp <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>,    <span class="fl">0.01</span>,    <span class="fl">0.01</span>,    <span class="fl">0.01</span>,  <span class="fl">0.1</span>,  <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod_agetime</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mod_pois.html">mod_pois</a></span><span class="op">(</span><span class="va">births</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">time</span>,</span>
<span>                        data <span class="op">=</span> <span class="va">births_time</span>,</span>
<span>                              exposure <span class="op">=</span> <span class="va">popn</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_datamod_undercount.html">set_datamod_undercount</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="va">prob_under_agetime</span><span class="op">)</span></span></code></pre></div>
<p>The model assumes that births for women aged 35+ in 2022 were subject to an unusual degree of under-reporting. The results reflect that assumption.</p>
<p><img src="vig10_datamod_files/figure-html/unnamed-chunk-29-1.png"><!-- --></p>
</div>
<div class="section level2" number="4">
<h2 id="forecasting-with-data-models">
<span class="header-section-number">4</span> Forecasting with data models<a class="anchor" aria-label="anchor" href="#forecasting-with-data-models"></a>
</h2>
<div class="section level3" number="4.1">
<h3 id="data-model-parameters-constant-over-time">
<span class="header-section-number">4.1</span> Data model parameters constant over time<a class="anchor" aria-label="anchor" href="#data-model-parameters-constant-over-time"></a>
</h3>
<p>Data models can be used in forecasting applications. Implementation is easiest with the data model does not contain any time-varying parameters, like the <code>mod_timeconst</code> constructed above:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_timeconst</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fl">2024</span><span class="op">)</span></span>
<span><span class="co">#&gt; Building log-posterior function...</span></span>
<span><span class="co">#&gt; Finding maximum...</span></span>
<span><span class="co">#&gt; Drawing values for hyper-parameters...</span></span>
<span><span class="co">#&gt; `components()` for past values...</span></span>
<span><span class="co">#&gt; `components()` for future values...</span></span>
<span><span class="co">#&gt; `augment()` for future values...</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 9 × 8</span></span></span>
<span><span class="co">#&gt;   age    time births .births  popn .observed                    .fitted</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 10-14  <span style="text-decoration: underline;">2</span>024     <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span> 5.4e-05 (1.8e-05, 0.00016)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 15-19  <span style="text-decoration: underline;">2</span>024     <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span> 0.00045 (0.00025, 0.00082)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 20-24  <span style="text-decoration: underline;">2</span>024     <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span>      0.0061 (0.0038, 0.01)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 25-29  <span style="text-decoration: underline;">2</span>024     <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span>       0.041 (0.026, 0.067)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 30-34  <span style="text-decoration: underline;">2</span>024     <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span>          0.1 (0.067, 0.17)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 35-39  <span style="text-decoration: underline;">2</span>024     <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span>        0.047 (0.03, 0.078)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> 40-44  <span style="text-decoration: underline;">2</span>024     <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span>     0.0075 (0.0047, 0.012)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> 45-49  <span style="text-decoration: underline;">2</span>024     <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span> 0.00013 (6.4e-05, 0.00025)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">9</span> 50-54  <span style="text-decoration: underline;">2</span>024     <span style="color: #BB0000;">NA</span>      <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>        <span style="color: #BB0000;">NA</span>   1.2e-05 (2.8e-06, 6e-05)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: .expected &lt;rdbl&lt;1000&gt;&gt;</span></span></span></code></pre></div>
<p>If future values for population are supplied, then the forecast will include true and reported values for the outcome variable:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">newdata_births</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"10-14"</span>, <span class="st">"15-19"</span>, <span class="st">"20-24"</span>, <span class="st">"25-29"</span>, <span class="st">"30-34"</span>,</span>
<span>          <span class="st">"35-39"</span>, <span class="st">"40-44"</span>, <span class="st">"45-49"</span>, <span class="st">"50-54"</span><span class="op">)</span>,</span>
<span>  time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">2024</span>, <span class="fl">9</span><span class="op">)</span>,</span>
<span>  popn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">27084</span>, <span class="fl">25322</span>, <span class="fl">23935</span>, <span class="fl">28936</span>, <span class="fl">30964</span>,</span>
<span>           <span class="fl">31611</span>, <span class="fl">44567</span>, <span class="fl">41774</span>, <span class="fl">51312</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod_timeconst</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">newdata_births</span><span class="op">)</span></span>
<span><span class="co">#&gt; Building log-posterior function...</span></span>
<span><span class="co">#&gt; Finding maximum...</span></span>
<span><span class="co">#&gt; Drawing values for hyper-parameters...</span></span>
<span><span class="co">#&gt; `components()` for past values...</span></span>
<span><span class="co">#&gt; `components()` for future values...</span></span>
<span><span class="co">#&gt; `augment()` for future values...</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 9 × 8</span></span></span>
<span><span class="co">#&gt;   age    time            births           .births  popn .observed</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;rdbl&lt;1000&gt;&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 10-14  <span style="text-decoration: underline;">2</span>024          1 (0, 5)          1 (0, 6) <span style="text-decoration: underline;">27</span>084        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 15-19  <span style="text-decoration: underline;">2</span>024         9 (3, 21)        11 (4, 25) <span style="text-decoration: underline;">25</span>322        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 20-24  <span style="text-decoration: underline;">2</span>024     117 (72, 200)     145 (89, 244) <span style="text-decoration: underline;">23</span>935        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 25-29  <span style="text-decoration: underline;">2</span>024   936 (590, 1521)  1178 (744, 1954) <span style="text-decoration: underline;">28</span>936        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 30-34  <span style="text-decoration: underline;">2</span>024 2592 (1584, 4361) 3244 (2083, 5438) <span style="text-decoration: underline;">30</span>964        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 35-39  <span style="text-decoration: underline;">2</span>024  1196 (765, 1942)  1489 (965, 2434) <span style="text-decoration: underline;">31</span>611        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> 40-44  <span style="text-decoration: underline;">2</span>024    264 (162, 448)    335 (210, 562) <span style="text-decoration: underline;">44</span>567        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> 45-49  <span style="text-decoration: underline;">2</span>024         4 (1, 10)         5 (1, 13) <span style="text-decoration: underline;">41</span>774        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">9</span> 50-54  <span style="text-decoration: underline;">2</span>024          0 (0, 4)          1 (0, 4) <span style="text-decoration: underline;">51</span>312        <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: .fitted &lt;rdbl&lt;1000&gt;&gt;, .expected &lt;rdbl&lt;1000&gt;&gt;</span></span></span></code></pre></div>
</div>
<div class="section level3" number="4.2">
<h3 id="data-model-parameters-vary-over-time">
<span class="header-section-number">4.2</span> Data model parameters vary over time<a class="anchor" aria-label="anchor" href="#data-model-parameters-vary-over-time"></a>
</h3>
<p>When the data model contains parameters that vary over time, future values for these parameters must be specified. This is done when the data model is first created. Here, for, instance, we create a version of the <code>prob_under_time</code> prior that includes values for 2024.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prob_under_time_ext</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="va">prob_under_time</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fl">2024</span>,</span>
<span>             mean <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>             disp <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">prob_under_time_ext</span></span>
<span><span class="co">#&gt;   time mean disp</span></span>
<span><span class="co">#&gt; 1 2021 0.99 0.01</span></span>
<span><span class="co">#&gt; 2 2022 0.80 0.02</span></span>
<span><span class="co">#&gt; 3 2023 0.99 0.01</span></span>
<span><span class="co">#&gt; 4 2024 0.95 0.05</span></span></code></pre></div>
<p>Our dataset only contains values up to 2023. When we fit our model, <code>bage</code> only uses prior values for the data model up to 2023. But when we forecast, <code>bage</code> uses the prior values for 2024.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_under_time_ext</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mod_pois.html">mod_pois</a></span><span class="op">(</span><span class="va">births</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">time</span>,</span>
<span>                               data <span class="op">=</span> <span class="va">births_time</span>,</span>
<span>                               exposure <span class="op">=</span> <span class="va">popn</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_datamod_undercount.html">set_datamod_undercount</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="va">prob_under_time_ext</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fl">2024</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2" number="5">
<h2 id="confidentialization-with-data-models">
<span class="header-section-number">5</span> Confidentialization with data models<a class="anchor" aria-label="anchor" href="#confidentialization-with-data-models"></a>
</h2>
<p><code>bage</code> allows for the possibility that the outcome variable has been subject to measurement errors <em>and</em> has been confidentialized. The following model assumes that births have been under-reported, and have been randomly rounded to multiples of 3.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">births_rr3</span> <span class="op">&lt;-</span> <span class="va">births</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>births <span class="op">=</span> <span class="fu"><a href="https://bayesiandemography.github.io/poputils/reference/rr3.html" class="external-link">rr3</a></span><span class="op">(</span><span class="va">births</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod_under_rr3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mod_pois.html">mod_pois</a></span><span class="op">(</span><span class="va">births</span> <span class="op">~</span> <span class="va">age</span>,</span>
<span>                          data <span class="op">=</span> <span class="va">births_rr3</span>,</span>
<span>              exposure <span class="op">=</span> <span class="va">popn</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_datamod_undercount.html">set_datamod_undercount</a></span><span class="op">(</span>prob <span class="op">=</span> <span class="va">prob_under</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/set_confidential_rr3.html">set_confidential_rr3</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2" number="6">
<h2 id="future-developments-specialised-data-models">
<span class="header-section-number">6</span> Future developments: specialised data models<a class="anchor" aria-label="anchor" href="#future-developments-specialised-data-models"></a>
</h2>
<p>The undercount, overcount, miscount, noise, and exposure data models allow analysts to account for general types of measurement error commonly encountered in applied demography. Like all models in <code>bage</code>, the data models are designed to be fast, even with large datasets.</p>
<p>As <code>bage</code> develops further, we would like to complement the existing suite of data models with additional, more specialized models. We would, for instance, like to add a special model for data, such as births data, where there are gaps between the date of occurrence and the date of registration. We welcome suggestions for specialised models.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by John Bryant, Junni Zhang.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
