---
title: "10. Data Models"
output:
  bookdown::html_document2:
    base_format: rmarkdown::html_vignette
    fig_caption: yes
    toc: true
    toc_depth: 2
    number_sections: true
pkgdown:
  as_is: true
vignette: >
  %\VignetteIndexEntry{10. Data Models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: references.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, include = FALSE}
library(bage)
library(dplyr)
births <- kor_births |>
  filter(region == "Ulsan",
         time == 2023) |>
  select(age, births, popn)
```

# Introduction




```{r}
library(bage)
library(poputils)
library(dplyr)
library(ggplot2)
library(patchwork)
```


```{r}
births
```

```{r, echo = FALSE, fig.width = 3, fig.height = 3}
ggplot(births, aes(x = age_mid(age))) +
  geom_point(aes(y = births),
             color = "darkblue") +
  xlab("Age") +
  ylab("Birth count")
```


```{r}
mod_base <- mod_pois(births ~ age,
                     data = births,
                     exposure = popn) |>
  set_prior(age ~ SVD(HFD)) |>
  set_disp(mean = 0) |>
  fit()
mod_base
```

```{r, fig.width = 3, fig.height = 3, echo = FALSE, message = FALSE}
aug_base <- mod_base |>
  augment() |>
  mutate(draws_ci(.fitted))

ggplot(aug_base, aes(x = age_mid(age))) +
  geom_ribbon(aes(ymin = .fitted.lower,
                  ymax = .fitted.upper),
              fill = "lightblue") +
  geom_line(aes(y = .fitted.mid),
            color = "darkblue") +
  xlab("Age") +
  ylab("Birth rate")
```

# Current menu of data models

## Overview

| **Model**  | **Assumptions about measurement error**       | **Poisson** | **Binomial** | **Normal** |
|:-----------|:----------------------------------------------|:---------|:----------|:---------|
| Miscount   | Reported outcome has undercount and overcount | Yes | No | No |
| Undercount | Reported outcome has undercount               | Yes | Yes | No |
| Overcount  | Reported outcome has overcount                | Yes | No | No |
| Noise      | Reported outcome unbiased, but with positive and negative measurement errors | Yes* | No | Yes |
| Exposure   | Reported exposure unbiased, but with positive and negative measurement errors | Yes* | No | No |

*Models with no dispersion term for rates.


## Undercount model

\begin{align}
  y_i^{\text{obs}} & \sim \text{Binomial}(y_i^{\text{true}}, \pi_{g[i]}) \\
  \pi_g & \sim \text{Beta}\left( \frac{m_g}{d_g}, \frac{1-m_g}{d_g} \right)
\end{align}


```{r}
prob_under <- data.frame(mean = 0.8, disp = 0.02)
```

```{r, message = FALSE}
mod_under <- mod_base |>
  set_datamod_undercount(prob = prob_under) |>
  fit()
mod_under
```

```{r, messages = FALSE}
mod_under |>
  augment()
```

```{r, echo = FALSE, fig.width = 6, fig.height = 6, message = FALSE, warning = FALSE}
aug_under <- mod_under |>
  augment() |>
  mutate(draws_ci(.births)) |>
  mutate(draws_ci(.fitted))

data <- bind_rows(Base = aug_base, 
                  Undercount = aug_under,
                  .id = "model") |>
  mutate(.births.mid = if_else(is.na(.births.mid), births, .births.mid))

p_rate <- ggplot(data, aes(x = age_mid(age))) +
  facet_wrap(vars(model)) +
  geom_ribbon(aes(ymin = .fitted.lower,
                  ymax = .fitted.upper),
              fill = "lightblue") +
  geom_line(aes(y = .fitted.mid),
            color = "darkblue") +
  xlab("Age") +
  ylab("Birth rate")

p_count <- ggplot(data, aes(x = age_mid(age))) +
  facet_wrap(vars(model)) +
  geom_point(aes(y = .births.mid),
             color = "darkblue") +
  geom_linerange(aes(ymin = .births.lower,
                     ymax = .births.upper),
		 data = filter(data, model == "Undercount"),
	         color = "darkblue") +
  xlab("Age") +
  ylab("Birth count")

p_rate / p_count
```

```{r}
mod_under |>
  components() |>
  filter(term == "datamod")
```


## Overcount model


\begin{align}
  y_i^{\text{obs}} & = y_i^{\text{true}} + \epsilon_i \\
  \epsilon_i & \sim \text{Poisson}( \kappa_{g[i]}  \gamma_i w_i) \\
  \kappa_g & \sim \text{Gamma}\left(\frac{1}{d_g}, \frac{1}{m_g d_g} \right)
\end{align}


```{r}
rate_over <- data.frame(mean = 0.1, disp = 0.05)
```

```{r}
mod_over <- mod_base |>
  set_datamod_overcount(rate = rate_over)
```

```{r, echo = FALSE, fig.width = 6, fig.height = 6, message = FALSE}
mod_over <- mod_over |>
  fit()

aug_over <- mod_over |>
  augment(quiet = TRUE) |>
  mutate(draws_ci(.births)) |>
  mutate(draws_ci(.fitted))

data <- bind_rows(Base = aug_base, 
                  Overcount = aug_over,
                  .id = "model") |>
  mutate(.births.mid = if_else(is.na(.births.mid), births, .births.mid))

p_rate <- ggplot(data, aes(x = age_mid(age))) +
  facet_wrap(vars(model)) +
  geom_ribbon(aes(ymin = .fitted.lower,
                  ymax = .fitted.upper),
              fill = "lightblue") +
  geom_line(aes(y = .fitted.mid),
            color = "darkblue") +
  xlab("Age") +
  ylab("Birth rate")

p_count <- ggplot(data, aes(x = age_mid(age))) +
  facet_wrap(vars(model)) +
  geom_point(aes(y = .births.mid),
             color = "darkblue") +
  geom_linerange(aes(ymin = .births.lower,
                     ymax = .births.upper),
		 data = filter(data, model == "Overcount"),
	         color = "darkblue") +
  xlab("Age") +
  ylab("Birth count")

p_rate / p_count
```

```{r}
mod_over |>
  components() |>
  filter(term == "datamod")
```

## Miscount model


\begin{align}
  y_i^{\text{obs}} & = u_i + v_i \\
  u_i & \sim \text{Binomial}(y_i^{\text{true}}, \pi_{g[i]}) \\
  v_i & \sim \text{Poisson}( \kappa_{h[i]}  \gamma_i w_i) \\
  \pi_g & \sim \text{Beta}\left( \frac{m_g}{d_g}, \frac{1-m_g}{d_g} \right) \\
  \kappa_h & \sim \text{Gamma}\left(\frac{1}{d_h}, \frac{1}{m_h d_h} \right)
\end{align}

```{r, message = FALSE}
mod_mis <- mod_base |>
  set_datamod_miscount(prob = prob_under,
                       rate = rate_over)
```

```{r, echo = FALSE, fig.width = 6, fig.height = 6, message = FALSE}
mod_mis <- mod_mis |>
  fit()

aug_mis <- mod_mis |>
  augment(quiet = TRUE) |>
  mutate(draws_ci(.births)) |>
  mutate(draws_ci(.fitted))

data <- bind_rows(Base = aug_base, 
                  Miscount = aug_mis,
                  .id = "model") |>
  mutate(.births.mid = if_else(is.na(.births.mid), births, .births.mid))

p_rate <- ggplot(data, aes(x = age_mid(age))) +
  facet_wrap(vars(model)) +
  geom_ribbon(aes(ymin = .fitted.lower,
                  ymax = .fitted.upper),
              fill = "lightblue") +
  geom_line(aes(y = .fitted.mid),
            color = "darkblue") +
  xlab("Age") +
  ylab("Birth rate")

p_count <- ggplot(data, aes(x = age_mid(age))) +
  facet_wrap(vars(model)) +
  geom_point(aes(y = .births.mid),
             color = "darkblue") +
  geom_linerange(aes(ymin = .births.lower,
                     ymax = .births.upper),
		 data = filter(data, model == "Miscount"),
	         color = "darkblue") +
  xlab("Age") +
  ylab("Birth count")

p_rate / p_count
```

```{r}
mod_mis |>
  components() |>
  filter(term == "datamod")
```


## Noise model


\begin{equation}
  y_i^{\text{obs}} = y_i^{\text{true}} + \epsilon_i
\end{equation}

\begin{equation}
  \epsilon_i \sim \text{N}(0, s_{g[i]}^2)
\end{equation}
\begin{equation}
  \epsilon_i \sim \text{Skellam}(m_{g[i]}, m_{g[i]})
\end{equation}
where $m_{g[i]} = \frac{1}{2} s^2$.


If $x_1 \sim \text{Poisson}{\mu_1}$, $x_2 \sim \text{Poisson}(\mu_2)$, and $y = x_1 + x_2$, then
\begin{equation}
  y \sim \text{Skellam}(\mu_1, \mu_2)
\end{equation}

If $\mu_1 = \mu_2 = \mu$, then $\text{E}[y] = 0$ and $\text{var}[y] = 2 \mu$.



```{r, message = FALSE}
mod_noise <- mod_base |>
  set_disp(mean = 0) |>
  set_datamod_noise(s = 50)
```

```{r, echo = FALSE, fig.width = 6, fig.height = 6, message = FALSE}
mod_noise <- mod_noise |>
  fit()

aug_noise <- mod_noise |>
  augment(quiet = TRUE) |>
  mutate(draws_ci(.births)) |>
  mutate(draws_ci(.fitted))

data <- bind_rows(Base = aug_base, 
                  Noise = aug_noise,
                  .id = "model") |>
  mutate(.births.mid = if_else(is.na(.births.mid), births, .births.mid))

p_rate <- ggplot(data, aes(x = age_mid(age))) +
  facet_wrap(vars(model)) +
  geom_ribbon(aes(ymin = .fitted.lower,
                  ymax = .fitted.upper),
              fill = "lightblue") +
  geom_line(aes(y = .fitted.mid),
            color = "darkblue") +
  xlab("Age") +
  ylab("Birth rate")

p_count <- ggplot(data, aes(x = age_mid(age))) +
  facet_wrap(vars(model)) +
  geom_point(aes(y = .births.mid),
             color = "darkblue") +
  geom_linerange(aes(ymin = .births.lower,
                     ymax = .births.upper),
		 data = filter(data, model == "Noise"),
	         color = "darkblue") +
  xlab("Age") +
  ylab("Birth count")

p_rate / p_count
```



## Exposure model


\begin{equation}
  w_i^{\text{obs}} \sim \text{InvGamma}(2 + d_{g[i]}^{-1}, [1 + d_{g[i]}^{-1}] w_i^{\text{true}})
\end{equation}


Note that
\begin{align}
  E[w_i^{\text{obs}} \mid w_i^{\text{true}}] & =  w_i^{\text{true}} \\
  \text{var}[w_i^{\text{obs}} \mid w_i^{\text{true}}] & = d_{g[i]} ( w_i^{\text{true}})^2 \\
  \text{cv}[w_i^{\text{obs}} \mid w_i^{\text{true}}] & = \sqrt{d_{g[i]}}
\end{align}


```{r, message = FALSE}
mod_expose <- mod_base |>
  set_disp(mean = 0) |>
  set_datamod_exposure(cv = 0.05)
```

```{r, echo = FALSE, fig.width = 6, fig.height = 6, message = FALSE}
mod_expose <- mod_expose |>
  fit()

aug_expose <- mod_expose |>
  augment(quiet = TRUE) |>
  mutate(draws_ci(.popn)) |>
  mutate(draws_ci(.fitted))

data <- bind_rows(Base = aug_base, 
                  Expose = aug_expose,
                  .id = "model") |>
  mutate(.popn.mid = if_else(is.na(.popn.mid), popn, .popn.mid))

p_rate <- ggplot(data, aes(x = age_mid(age))) +
  facet_wrap(vars(model)) +
  geom_ribbon(aes(ymin = .fitted.lower,
                  ymax = .fitted.upper),
              fill = "lightblue") +
  geom_line(aes(y = .fitted.mid),
            color = "darkblue") +
  xlab("Age") +
  ylab("Birth rate")

p_popn <- ggplot(data, aes(x = age_mid(age))) +
  facet_wrap(vars(model)) +
  geom_point(aes(y = .popn.mid),
             color = "darkblue") +
  geom_linerange(aes(ymin = .popn.lower,
                     ymax = .popn.upper),
		 data = filter(data, model == "Expose"),
	         color = "darkblue") +
  ylim(0, NA) +	 
  xlab("Age") +
  ylab("Population")

p_rate / p_popn
```


# More complicated error specifications

```{r, include = FALSE}
births_time <- kor_births |>
  filter(region == "Ulsan",
         time %in% 2021:2023) |>
  select(age, time, births, popn)
```

```{r}
births_time
```

```{r}
prob_under_time <- data.frame(time = c(2021, 2022, 2023),
                              mean = c(0.99, 0.8, 0.99),
			      disp = c(0.01, 0.02, 0.01))
```


```{r}
mod_timeconst <- mod_pois(births ~ age + time,
                          data = births_time,
			  exposure = popn) |>
  set_datamod_undercount(prob = prob_under)

mod_timevarying <- mod_timeconst |>
  set_datamod_undercount(prob = prob_under_time)
```

```{r, echo = FALSE, fig.width = 6, fig.height = 6, message = FALSE, warning = FALSE}
aug_timeconst <- mod_timeconst |>
  fit() |>
  augment() |>
  mutate(draws_ci(.fitted))

aug_timevarying <- mod_timevarying |>
  fit() |>
  augment() |>
  mutate(draws_ci(.fitted))

data <- bind_rows(Constant = aug_timeconst, 
                  Varying = aug_timevarying,
                  .id = "model")

ggplot(data, aes(x = age_mid(age))) +
  facet_grid(vars(model), vars(time)) +
  geom_ribbon(aes(ymin = .fitted.lower,
                  ymax = .fitted.upper),
              fill = "lightblue") +
  geom_line(aes(y = .fitted.mid),
            color = "darkblue") +
  xlab("Age") +
  ylab("Birth rate")
```


```{r}
births_time <- births_time |>
  mutate(agegp = if_else(age %in% c("35-39", "40-44",
                                    "45-49", "50-54"),
                         "35+", "10-34"))

prob_under_agetime <- data.frame(
  time =  c(2021,    2022,    2023,    2021,  2022,  2023),
  agegp = c("10-34", "10-34", "10-34", "35+", "35+", "35+"),
  mean =  c(0.99,    0.99,    0.99,    0.99,  0.5,  0.99),
  disp =  c(0.01,    0.01,    0.01,    0.01,  0.1,  0.01))

mod_agetime <- mod_pois(births ~ age + time,
                        data = births_time,
			exposure = popn) |>
  set_datamod_undercount(prob = prob_under_agetime)
```

```{r, echo = FALSE, fig.width = 6, fig.height = 3, message = FALSE, warning = FALSE}
aug_agetime <- mod_agetime |>
  fit() |>
  augment() |>
  mutate(draws_ci(.fitted))

ggplot(aug_agetime, aes(x = age_mid(age))) +
  facet_wrap(vars(time)) +
  geom_ribbon(aes(ymin = .fitted.lower,
                  ymax = .fitted.upper),
              fill = "lightblue") +
  geom_line(aes(y = .fitted.mid),
            color = "darkblue") +
  xlab("Age") +
  ylab("Birth rate")
```
  

# Forecasting with data models

## Data model parameters constant over time

```{r}
mod_timeconst |>
  fit() |>
  forecast(label = 2024)
```

```{r}
newdata_births <- data.frame(
  age = c("10-14", "15-19", "20-24", "25-29", "30-34",
          "35-39", "40-44", "45-49", "50-54"),
  time = rep(2024, 9),
  popn = c(27084, 25322, 23935, 28936, 30964,
           31611, 44567, 41774, 51312))

mod_timeconst |>
  fit() |>
  forecast(newdata = newdata_births)
```


## Data model parameters vary over time

```{r}
prob_under_time_ext <- rbind(
  prob_under_time,
  data.frame(time = 2024,
             mean = 0.95,
             disp = 0.05))
prob_under_time_ext
```	     

```{r, message = FALSE}
mod_under_time_ext <- mod_pois(births ~ age + time,
                               data = births_time,
                               exposure = popn) |>
  set_datamod_undercount(prob = prob_under_time_ext) |>
  fit()
```

```{r}
mod_under_time_ext |>
  forecast(labels = 2024)
```


```{r, message = FALSE}
mod_under_time_ext |>
  forecast(labels = 2024,
           output = "components") |>
  filter(term == "datamod")	   
```

# Replicate data tests with data models

```{r}
repdata <- replicate_data(mod_timeconst)
repdata
```

```{r}
ggplot(repdata, aes(x = age_mid(age), y = births, col = factor(time))) +
  facet_wrap(vars(.replicate)) +
  geom_line()
```

# Confidentialization with data models

```{r}
births_rr3 <- births |>
  mutate(births = rr3(births))

mod_under_rr3 <- mod_pois(births ~ age,
                          data = births_rr3,
			  exposure = popn) |>
  set_confidential_rr3()
```


# Future developments: specialised data models








