---
title: "3. Priors"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{3. Priors}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo = TRUE,
  comment = "#>",
  fig.width = 6,
  fig.height = 3
)
```

# Set-up

```{r setup}
suppressPackageStartupMessages({
  library(bage)
  library(poputils)
  library(ggplot2)
  library(dplyr)
})	
```


```{r}
mx <- west_lifetab |>
  filter(sex == "Female", level == 23) |>
  select(age, sex, mx)
```

```{r}
convert_to_lifeexp <- function(draws) {
  draws |>
    cross_join(mx) |>
    mutate(mx = exp(value) * mx) |>
    lifeexp(mx = mx, age = age, sex = sex, by = c(element, replicate)) |>
    select(element, replicate, value = ex)
}
```

```{r}
plot_points <- function(draws) {
  ggplot(draws, aes(x = element, y = value)) +
    facet_wrap(vars(replicate), nrow = 1) +
    geom_point(col = "darkblue", size = 0.7) +
    scale_x_continuous(n.breaks = max(draws$element)) +
    xlab("Element") +
    ylab("") +
    theme(text = element_text(size = 8))
}	       
```

```{r}
plot_lines <- function(draws) {
  ggplot(draws, aes(x = element, y = value)) +
    facet_wrap(vars(replicate), nrow = 1) +
    geom_line(col = "darkblue") +
    xlab("Element") +
    ylab("") +
    theme(text = element_text(size = 8))
}	       
```


```{r}
make_scaled_versions <- function(draws) {
  prior <- draws |>
    mutate(variant = "Original")
  log <- draws |>
    mutate(variant = "Exp") |>
    mutate(value = exp(value))
  logit <- draws |>
    mutate(variant = "Inv-Logit") |>
    mutate(value = exp(value) / (1 + exp(value)))
  bind_rows(prior, log, logit) |>
    mutate(variant = factor(variant, levels = unique(variant)))
}
```


```{r}
plot_points_scales <- function(draws) {
  ggplot(draws, aes(x = element, y = value)) +
    facet_grid(vars(variant), vars(replicate), scale = "free_y") +
    geom_point(col = "darkblue", size = 0.7) +
    scale_x_continuous(n.breaks = max(draws$element)) +
    xlab("Element") +
    ylab("") +
    theme(text = element_text(size = 8))
}
```


# Normal `N()`

## Model

\begin{align}
  \beta_j & \sim \text{N}(0, \tau^2) \\
  \tau & \sim \text{N}^+(0, 1)
\end{align}

## Values with all defaults


Values on log scale

```{r, fig.height = 1.5}
set.seed(0)
N() |>
  generate(n_element = 10, n_replicate = 6) |>
  plot_points()
```



```{r}
set.seed(0)
N() |>
  generate(n_element = 10, n_replicate = 6) |>
  make_scaled_versions() |>
  plot_points_scales()
```


## Values with `s = 0.05`


```{r, fig.height = 1.5}
set.seed(0)
N(s = 0.05) |>
  generate(n_element = 10, n_replicate = 6) |>
  plot_points()
```


```{r}
set.seed(0)
N(s = 0.05) |>
  generate(n_element = 10, n_replicate = 6) |>
  make_scaled_versions() |>
  plot_points_scales()
```


# Random Walk `RW()`

## Model

\begin{align}
  \beta_1 & \sim \text{N}(0, \text{sd}^2) \\
  \beta_j & \sim \text{N}(\beta_{j-1}, \tau^2), \quad j = 2, \cdots, J \\
  \tau & \sim \text{N}^+(0, 1)
\end{align}
