---
title: "3. Priors"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{3. Priors}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo = TRUE,
  comment = "#>",
  fig.width = 6,
  fig.height = 3
)
```

# Set-up

```{r setup}
suppressPackageStartupMessages({
  library(bage)
  library(poputils)
  library(ggplot2)
  library(dplyr)
})	
```


```{r}
draw_vals <- function(x, n) {
  x |>
  generate(n = n, n_draw = 18) |>
  mutate(draw = paste("Draw", draw),
         draw = factor(draw, levels = unique(draw)))
}
```

```{r}
mx <- west_lifetab |>
  filter(sex == "Female", level == 23) |>
  select(age, sex, mx)
```

```{r}
convert_to_lifeexp <- function(draws) {
  draws |>
  cross_join(mx) |>
  mutate(mx = exp(value) * mx) |>
  lifeexp(mx = mx, age = age, sex = sex, by = c(x, draw))
}
```

```{r}
plot_points <- function(draws) {
  ggplot(draws, aes(x = x, y = value)) +
    facet_wrap(vars(draw), nrow = 3) +
    geom_point(col = "darkblue", size = 0.7) +
    scale_x_continuous(n.breaks = max(draws$x)) +
    xlab("Unit") +
    ylab("") +
    theme(text = element_text(size = 8))
}	       
```

```{r}
plot_lines <- function(draws) {
  ggplot(draws, aes(x = x, y = value)) +
    facet_wrap(vars(draw), nrow = 3) +
    geom_line(col = "darkblue") +
    xlab("Unit") +
    ylab("") +
    theme(text = element_text(size = 8))
}	       
```



# Priors for Exchangeable Units

## Normal `N()`

\begin{align}
  \beta_j & \sim \text{N}(0, \tau^2) \\
  \tau & \sim N^+(0, 1)
\end{align}

### All defaults

```{r}
x <- N()
x
```

Values on log scale

```{r}
draws <- N() |>
  draw_vals(n = 10)
```

```{r}
plot_points(draws)
```

Life expectancies when mortality rates multiplied by draws

```{r}
draws |>
  convert_to_lifeexp() |>
  plot_points()
```




## Reduce value for `s`

```{r, echo = TRUE}
x <- N(s = 0.05)
x
```


```{r}
x <- N(s = 0.05)
draws <- draws_point(x)
plot_prior_point(draws)
```

Draws from `N(s = 0.05)` converted to life expectancy
```{r}
plot_lifeexp_point(draws)
```


# Priors for Series

## Random Walk `RW()`

Draws from `RW()`
```{r}
x <- RW()
draws <- draws_line(x)
plot_prior_line(draws)
```

```{r}
plot_lifeexp_line(draws)
```

```{r}
x <- RW(s = 0.01)
draws <- draws_line(x)
plot_prior_line(draws)
```

```{r}
plot_lifeexp_line(draws)
```


## Second-order Random Walk `RW2()`


```{r}
x <- RW2()
draws <- draws_line(x)
plot_prior_line(draws)
```

```{r}
plot_lifeexp_line(draws)
```


```{r}
x <- RW2(s = 0.01)
draws <- draws_line(x)
plot_prior_line(draws)
```

```{r}
plot_lifeexp_line(draws)
```

```{r}
x <- RW2(s = 0.01, sd = 0.01)
draws <- draws_line(x)
plot_prior_line(draws)
```

```{r}
plot_lifeexp_line(draws)
```
