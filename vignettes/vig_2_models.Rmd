---
title: "vig_2_models"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{vig_2_models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: references.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(bage)
```



# Specification of models

Note: this is describing the models we want to get to, not the ones we currently implement.

## Likelihood

### Poisson

Let $y_i$ be a count of events (eg births) in cell $i = 1, \cdots, n$ and $w_i$ the corresponding exposure measure (with the possibility that $w_i \equiv 1). Then our Poisson model
\begin{align}
  y_i & \sim \text{Poisson}(\gamma_i w_i) \\
  \gamma_i & \sim \text{Gamma}\left(\xi^{-1}, (\mu_i \xi)^{-1}\right)
\end{align}
where the Gamma distribution has a shape-rate parameterisation. Parameter $\xi$ governs over-dispersion:
\begin{equation}
  \text{var}(y_i \mid \mu_i, \xi, w_i) = \mu_i w_i (1 + \xi \mu_i w_i ).
\end{equation}
We allow $\xi$ to equal 0, in which case the model reduces to 
\begin{equation}
  y_i \sim \text{Poisson}(\mu_i w_i).
\end{equation}

  
For $\xi > 0$, our model is equivalent to 
\begin{equation}
  y_i \sim \text{NegBinom}\left(\xi^{-1}, (1 + \mu_i w_i \xi)^{-1}\right),
\end{equation}
[@norton2018sampling; @simpson2022priors]. The negative binomial form is how we estimate the model internally. If users require values for $\gamma_i$, then we can generate them on the fly, using the fact that, for known values of $\mu_i, \xi_i$,
\begin{equation}
  \gamma_i \sim \text{Gamma}\left(y_i + \xi^{-1}, w_i + (\xi \mu_i)^{-1}\right).
\end{equation}

Prior for $\xi$:
\begin{equation}
  p(\xi) = \frac{s}{2 \sqrt{\xi}}e^{-s \sqrt{\xi}}
\end{equation}
[@simpson2022priors] for some value of $s$. TODO - choice of $s$.

### Binomial


\begin{align}
  y_i & \sim \text{Binomial}(w_i, \gamma_i) \\
  \gamma_i & \sim \text{Beta}\left((1-\xi)\xi^{-1}\mu_i, (1-\xi)\xi^{-1}(1 - \mu_i)\right)
\end{align}
Parameter $\xi$ in this case governs intra-class correlation, which is closely related to overdispersion [@enwiki:1140557862].

We allow $\xi$ to equal 0, in which case the model reduces to 
\begin{equation}
  y_i \sim \text{Binom}(w_i, \mu_i).
\end{equation}


For $\xi > 0$, our model is equivalent to 
\begin{equation}
  y_i \sim \text{BetaBinom}\left(w_i, (1-\xi)\xi^{-1}\mu_i, (1-\xi)\xi^{-1}(1 - \mu_i)\right).
\end{equation}
The Beta-Binomial form is how we estimate the model internally. If users require values for $\gamma_i$, then we can generate them on the fly, using the fact that, for known values of $\mu_i, \xi_i$,
\begin{equation}
  \gamma_i \sim \text{Beta}\left(y_i + (1-\xi)\xi^{-1}\mu_i, w_i - y_i + (1-\xi)\xi^{-1}(1-\mu_i)\right).
\end{equation}

Prior for $\xi$?
\begin{equation}
  \xi \sim \text{Beta}(2, 2)
\end{equation}
boundary-avoiding prior (@gelman2014bayesian, p317).


### Normal

\begin{equation}
  y_i \sim \text{N}(\mu_i, w_i^{-1}\xi^2).
\end{equation}

## Model for mean parameter $\mu_i$

Let $\beta^{(m)}$, $m=1,\cdots,M$, denote a main effect or interaction, and $\beta^0$ an intercept. Let $p_m$ denote the number of elements of $\beta^{(m)}$. Let $J_m$ be a $n \times p_m$ matrix of 1s and 0s, the $i$th row of which picks out the element of $\beta^{m}$ to use with cell $i$. Let $g$ denote the log function in the case of Poisson models, the logit function in the case of binomial models, and the identity function in the case of normal models. Then
\begin{equation}
  \mu = \sum_{m=0}^{M} J_m \beta^{(m)}
\end{equation}

TODO - also allow for a covariate term.

## Prior models for main effects and interactions

All have common format:
\begin{equation}
  \beta^{(m)} = K_m \alpha^{(m)}
\end{equation}

### Normal prior

\begin{equation}
  \alpha_v^{(m)} \sim \text{N}(0, \tau^2), \quad v = 1, \dots, p_m,
\end{equation}
with $K_m = I_{p_m}$.

### Random walk prior

\begin{equation}
  \alpha_v^{(m)} \sim \text{N}(0, \tau^2), \quad v = 1, \dots, p_m-1,
\end{equation}
with $K_m = ???$.



### Second order random walk prior

\begin{equation}
  \alpha_v^{(m)} \sim \text{N}(0, \tau^2), \quad v = 1, \dots, p_m-2,
\end{equation}
with $K_m = ???$.


# References


